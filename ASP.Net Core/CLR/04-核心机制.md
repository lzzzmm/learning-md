# æ ¸å¿ƒæœºåˆ¶
## 20 å¼‚å¸¸å’ŒçŠ¶æ€ç®¡ç†
### 20.6 å®šä¹‰è‡ªå·±çš„å¼‚å¸¸ç±»
ä»Exceptionæ´¾ç”Ÿçš„æ‰€æœ‰ç±»å‹éƒ½åº”è¯¥æ˜¯å¯åºåˆ—åŒ–çš„ï¼Œä½¿å®ƒä»¬èƒ½ç©¿è¶ŠAPPDomainè¾¹ç•Œæˆ–å†™å…¥æ—¥å¿—/æ•°æ®åº“ã€‚

.NET çš„ Exception ç±»å·²ç»æ˜¯ [Serializable] çš„ï¼Œå¹¶ä¸”å®ç°äº† ISerializable æ¥å£ï¼š
```cs
[Serializable]
public class Exception : ISerializable
{
    // ...
}
```
æ‰€ä»¥åªæ˜¯
```cs
public class MyException : Exception
{
    // æ²¡æœ‰ä»»ä½•å­—æ®µæˆ–å±æ€§
}
```
å®Œå…¨ä¸éœ€è¦ä½ åšä»»ä½•é¢å¤–æ“ä½œï¼Œå®ƒå°±æ˜¯å¯åºåˆ—åŒ–çš„ã€‚

ä½†æ˜¯å¦‚æœè¦æ·»åŠ è‡ªå®šä¹‰å­—æ®µçš„è¯ï¼š
```cs
[Serializable]
public class UserNotFoundException : Exception
{
    public string UserId { get; }

    public UserNotFoundException(string userId)
        : base($"User '{userId}' not found.")
    {
        UserId = userId;
    }

    // ååºåˆ—åŒ–æ„é€ å‡½æ•°
    protected UserNotFoundException(SerializationInfo info, StreamingContext context)
        : base(info, context)
    {
        UserId = info.GetString(nameof(UserId));
    }

    // è‡ªå®šä¹‰åºåˆ—åŒ–
    public override void GetObjectData(SerializationInfo info, StreamingContext context)
    {
        info.AddValue(nameof(UserId), UserId);
        base.GetObjectData(info, context); // ä¸å¯çœç•¥
    }
}

```

## 21 æ‰˜ç®¡å †å’Œåƒåœ¾å›æ”¶
### 21.1 æ‰˜ç®¡å †åŸºç¡€
æ¯ä¸ªç¨‹åºéƒ½è¦ä½¿ç”¨èµ„æºï¼ŒåŒ…æ‹¬æ–‡ä»¶ã€å†…å­˜ç¼“å†²åŒºã€å±å¹•ç©ºé—´ã€ç½‘ç»œè¿æ¥ã€æ•°æ®åº“èµ„æºç­‰ã€‚åœ¨é¢å‘å¯¹è±¡ç¯å¢ƒä¸­ï¼Œæ¯ä¸ªç±»å‹éƒ½ä»£è¡¨å¯ä¾›ç¨‹åºä½¿ç”¨çš„ä¸€ç§èµ„æºã€‚è¦ä½¿ç”¨è¿™äº›èµ„æºï¼Œå¿…é¡»ä¸ºä»£è¡¨èµ„æºçš„ç±»å‹åˆ†é…å†…å­˜ã€‚

ä»¥ä¸‹æ˜¯è®¿é—®ä¸€ä¸ªèµ„æºæ‰€éœ€çš„æ­¥éª¤ï¼š
- 1ã€è°ƒç”¨ILæŒ‡ä»¤newobjï¼Œä¸ºä»£è¡¨èµ„æºçš„ç±»å‹åˆ†é…å†…å­˜ï¼ˆC#ç”¨newï¼‰
- 2ã€åˆå§‹åŒ–å†…å­˜ï¼Œè®¾ç½®èµ„æºçš„åˆå§‹çŠ¶æ€å¹¶ä½¿èµ„æºå¯ç”¨ã€‚ç±»å‹çš„å®ä¾‹æ„é€ å™¨è´Ÿè´£è®¾ç½®åˆå§‹çŠ¶æ€
- 3ã€è®¿é—®ç±»å‹çš„æˆå‘˜æ¥ä½¿ç”¨èµ„æºï¼ˆæœ‰å¿…è¦å¯ä»¥é‡å¤ï¼‰
- 4ã€æ‘§æ¯èµ„æºçŠ¶æ€ä»¥è¿›è¡Œæ¸…ç†
- 5ã€é‡Šæ”¾å†…å­˜ï¼Œåƒåœ¾å›æ”¶å™¨ç‹¬è‡ªè´Ÿè´£è¿™ä¸€æ­¥

ä¸ºç®€åŒ–å˜æˆï¼Œç°åœ¨å¼€å‘äººå‘˜ç»å¸¸ä½¿ç”¨çš„å¤§å¤šæ•°ç±»å‹éƒ½ä¸éœ€è¦æ­¥éª¤4ï¼Œæ‰€ä»¥æ‰˜ç®¡å †èƒ½é¿å…ç¨‹åºå‘˜å¿˜è®°é‡Šæ”¾å†…å­˜è€Œé€ æˆå†…å­˜æ³„éœ²å’Œä½¿ç”¨å·²é‡Šæ”¾çš„å†…å­˜é€ æˆç¨‹åºé”™è¯¯å’Œå®‰å…¨æ¼æ´çš„é—®é¢˜ï¼Œä¹Ÿä¸ºç¨‹åºå‘˜æä¾›ä¸€ä¸ªç®€åŒ–çš„ç¼–ç¨‹æ¨¡å‹ï¼šåˆ†é…å¹¶åˆå§‹åŒ–èµ„æºå¹¶ç›´æ¥ä½¿ç”¨ã€‚å¤§å¤šæ•°ç±»å‹éƒ½æ— éœ€èµ„æºæ¸…ç†ï¼Œåƒåœ¾å›æ”¶å™¨ä¼šè‡ªåŠ¨é‡Šæ”¾å†…å­˜ã€‚

ä½¿ç”¨éœ€è¦ç‰¹æ®Šæ¸…ç†çš„ç±»å‹æ—¶ï¼Œç¼–ç¨‹æ¨¡å‹è¿˜åƒå¸‚æ°‘å•Šæè¿°çš„é‚£æ ·ã€‚åªæ˜¯æœ‰æ—¶éœ€è¦å°½å¿«æ¸…ç†èµ„æºè€Œä¸æ˜¯ç­‰ç€GCï¼ˆåƒåœ¾å›æ”¶ï¼Œåƒåœ¾å›æ”¶å™¨éƒ½å¯ä»¥ç®€ç§°ä¸ºGCï¼‰ä»‹å…¥ã€‚å¯åœ¨è¿™äº›ç±»ä¸­è°ƒç”¨ä¸€ä¸ªé¢å¤–çš„æ–¹æ³•ï¼ˆDisposeï¼‰ï¼ŒæŒ‰è‡ªå·±çš„èŠ‚å¥æ¸…ç†èµ„æºã€‚

#### 21.1.1 ä»æ‰˜ç®¡å †åˆ†é…èµ„æº

CLRè¦æ±‚æ‰€æœ‰å¯¹è±¡éƒ½ä»æ‰˜ç®¡å †åˆ†é…ã€‚è¿›ç¨‹åˆå§‹åŒ–æ—¶ï¼ŒCLRåˆ’å‡ºä¸€ä¸ªåœ°å€ç©ºé—´åŒºåŸŸä½œä¸ºæ‰˜ç®¡å †ã€‚CLRè¦ç»´æŠ¤ä¸€ç›´æŒ‡é’ˆNextObjPtrã€‚è¿™ä¸ªæŒ‡é’ˆæŒ‡å‘ä¸‹ä¸€ä¸ªå¯¹è±¡åœ¨å †ä¸­çš„åˆ†é…ä½ç½®ã€‚

ä¸€ä¸ªåŒºåŸŸè¢«éåƒåœ¾å¯¹è±¡å †æ»¡åï¼ŒCLRä¼šåˆ†é…æ›´å¤šåŒºåŸŸï¼ŒçŸ¥é“æ•´ä¸ªåœ°å€ç©ºé—´éƒ½è¢«å¡«æ»¡ã€‚æ‰€ä»¥ï¼Œåº”ç”¨ç¨‹åºçš„å†…å­˜å—è¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´é™åˆ¶ã€‚

newæ“ä½œç¬¦å¯¼è‡´CLRæ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š
- 1ã€è®¡ç®—ç±»å‹çš„å­—æ®µæ‰€éœ€çš„å­—èŠ‚æ•°
- 2ã€åŠ ä¸Šå¯¹è±¡çš„å¼€é”€æ‰€éœ€çš„å­—èŠ‚æ•°ï¼Œæ¯ä¸ªå¯¹è±¡éƒ½æœ‰ä¸¤ä¸ªå¼€é”€å­—æ®µï¼šç±»å‹å¯¹è±¡æŒ‡é’ˆå’ŒåŒæ­¥å—ç´¢å¼•
- 3ã€CLRæ£€æŸ¥åŒºåŸŸæ€»æ˜¯å¦æœ‰åˆ†é…å¯¹è±¡æ‰€éœ€çš„å­—èŠ‚æ•°ã€‚æœ‰çš„è¯ï¼Œåœ¨NextObjPtræŒ‡é’ˆæŒ‡å‘çš„åœ°å€å¤„æ”¾å…¥å¯¹è±¡ï¼Œä¸ºå¯¹è±¡åˆ†é…çš„å­—èŠ‚ä¼šè¢«æ¸…é›¶ã€‚æ¥ç€è°ƒç”¨ç±»å‹çš„æ„é€ å™¨ï¼Œnewæ“ä½œç¬¦è¿”å›å¯¹è±¡å¼•ç”¨ã€‚åœ¨è¿”å›è¿™ä¸ªå¼•ç”¨å‰ï¼ŒNextObjPtræŒ‡é’ˆçš„å€¼ä¼šåŠ ä¸Šå¯¹è±¡å¼ å‹‡çš„å­—èŠ‚æ•°æ¥å¾—åˆ°ä¸€ä¸ªæ–°å€¼ä½œä¸ºä¸‹ä¸ªå¯¹è±¡æ”¾å…¥æ‰˜ç®¡å †çš„åœ°å€

![2025-07-20-16-32-00.png](./images/2025-07-20-16-32-00.png)

ç”±äºæ‰˜ç®¡å †åœ¨å†…å­˜ä¸­è¿ç»­åˆ†é…è¿™äº›å¯¹è±¡ï¼Œæ‰€ä»¥ä¼šå› ä¸ºå¼•ç”¨çš„â€œå±€éƒ¨åŒ–â€è€Œè·å¾—æ€§èƒ½ä¸Šçš„æå‡ã€‚

CLRæ€»æ˜¯èƒ½åˆ†é…æ–°å¯¹è±¡ï¼Œä½†å†…å­˜ä¸å¯èƒ½æ— é™ï¼Œæ‰€ä»¥CLRé€šè¿‡ç§°ä¸ºâ€œåƒåœ¾å›æ”¶â€ï¼ˆGCï¼‰çš„æŠ€æœ¯â€œåˆ é™¤â€å †ä¸­åº”ç”¨ç¨‹åºä¸å†éœ€è¦çš„å¯¹è±¡ã€‚

#### 21.1.2 åƒåœ¾å›æ”¶ç®—æ³•
åº”ç”¨ç¨‹åºè°ƒç”¨newæ“ä½œç¬¦åˆ›å»ºå¯¹è±¡æ—¶ï¼Œå¯èƒ½æ²¡æœ‰è¶³å¤Ÿåœ°å€ç©ºé—´æ¥åˆ†é…è¯¥å¯¹è±¡ï¼Œå‘ç°ç©ºé—´ä¸å¤Ÿï¼ŒCLRå°±æ‰§è¡Œåƒåœ¾å›æ”¶ã€‚

å¯¹è±¡ç”Ÿå­˜æœŸçš„ç®¡ç†ï¼Œæœ‰çš„ç³»ç»Ÿæ›¹å‹‡çš„æ˜¯æŸç§å¼•ç”¨è®¡æ•°ï¼šå †ä¸Šçš„æ¯ä¸ªå¯¹è±¡éƒ½ç»´æŠ¤ä¸€ä¸ªå†…å­˜å­—æ®µç»Ÿè®¡ç¨‹åºä¸­å¤šå°‘â€œéƒ¨åˆ†â€æ­£ä½¿ç”¨å¯¹è±¡ã€‚éšç€æ¯ä¸€â€œéƒ¨åˆ†â€åˆ°è¾¾ä»£ç ä¸­æŸä¸ªä¸å†éœ€è¦å¯¹è±¡çš„åœ°æ–¹ï¼Œå°±é€’å‡å¯¹è±¡çš„è®¡æ•°å­—æ®µï¼Œç›´åˆ°ä¸º0ï¼Œå¯¹è±¡å°±å¯ä»¥ä»å†…å­˜ä¸­åˆ é™¤äº†ã€‚

å¼•ç”¨è®¡æ•°ç³»ç»Ÿæœ€å¤§çš„é—®é¢˜æ˜¯å¤„ç†ä¸å¥½å¾ªç¯å¼•ç”¨ã€‚åŸºäºè¿™ä¸ªé—®é¢˜ï¼ŒCLRæ”¹ä¸ºä½¿ç”¨ä¸€ç§å¼•ç”¨è·Ÿè¸ªç®—æ³•ï¼šåªå…³å¿ƒå¼•ç”¨ç±»å‹çš„å˜é‡ï¼Œå› ä¸ºåªæœ‰è¿™ç§å˜é‡æ‰èƒ½å¼•ç”¨å †ä¸Šçš„å¯¹è±¡ã€‚

åªç±»å‹å˜é‡ç›´æ¥åŒ…å«å€¼ç±»å‹å®ä¾‹ï¼Œè€Œåº”ç”¨ç±»å‹å˜é‡å¯ä»¥åŒ…æ‹¬ç±»çš„é™æ€å’Œå®ä¾‹å­—æ®µï¼Œæ–¹æ³•çš„å‚æ•°å’Œå±€éƒ¨å˜é‡ï¼Œå°†æ‰€æœ‰å¼•ç”¨ç±»å‹çš„å˜é‡ç§°ä¸ºâ€œæ ¹â€ã€‚

GCæ­¥éª¤ï¼š
- 1ã€æš‚åœè¿›ç¨‹ä¸­æ‰€æœ‰çº¿ç¨‹
- 2ã€CLRè¿›å…¥GCçš„æ ‡è®°é˜¶æ®µï¼ŒCLRéå†å †ä¸­æ‰€æœ‰å¯¹è±¡ï¼Œå°†åŒæ­¥ç´¢å¼•å­—æ®µä¸­çš„ä¸€ä½è®¾ä¸º0ï¼Œè¿™è¡¨æ˜æ‰€æœ‰å¯¹è±¡éƒ½åº”åˆ é™¤ï¼ˆGC ä¸çŸ¥é“å“ªäº›å¯¹è±¡è¿˜â€œæ´»ç€â€ã€å“ªäº›æ˜¯â€œåƒåœ¾â€ã€‚æ‰€ä»¥å®ƒå‡è®¾å…¨éƒ¨å¯¹è±¡éƒ½æ˜¯åƒåœ¾ï¼‰
- 3ã€CLRæ£€æŸ¥æ‰€æœ‰æ´»åŠ¨æ ¹ï¼ŒæŸ¥çœ‹å®ƒä»¬å¼•ç”¨äº†å“ªäº›å¯¹è±¡ï¼Œå¦‚æœä¸€ä¸ªæ ¹åŒ…å«nullï¼ŒCLRå¿½ç•¥è¿™ä¸ªæ ¹å¹¶ç»§ç»­æ£€æŸ¥ä¸‹ä¸€ä¸ªæ ¹
- 4ã€ä»»ä½•æ ¹å¦‚æœå¼•ç”¨äº†å †ä¸Šçš„å¯¹è±¡ï¼ŒCLRéƒ½ä¼šæ ‡è®°é‚£ä¸ªå¯¹è±¡ï¼Œå°±æ˜¯å°†è¯¥å¯¹è±¡çš„åŒæ­¥å—ç´¢å¼•ä¸­çš„ä½è®¾ä¸º1
- 5ã€ä¸€ä¸ªå¯¹è±¡è¢«æ ‡è®°åï¼ŒCLRæ£€æŸ¥é‚£ä¸ªå¯¹è±¡ä¸­çš„æ ¹ï¼Œæ ‡è®°å®ƒä»¬å¼•ç”¨çš„å¯¹è±¡ï¼Œå¦‚æœå‘ç°å¯¹è±¡å·²ç»æ ‡è®°ï¼Œå°±ä¸é‡æ–°æ£€æŸ¥å¯¹è±¡çš„å­—æ®µï¼Œé¿å…å› ä¸ºå¾ªç¯å¼•ç”¨è€Œäº§ç”Ÿæ­»å¾ªç¯


çœ‹ä¸‹é¢ä¾‹å­ï¼šåº”ç”¨ç¨‹åºçš„æ ¹ç›´æ¥å¼•ç”¨å¯¹è±¡Aï¼ŒCï¼ŒDï¼ŒFã€‚æ‰€æœ‰å¯¹è±¡éƒ½å·²æ ‡è®°ã€‚æ ‡è®°å¯¹è±¡Dæ—¶ï¼Œåƒåœ¾å›æ”¶å™¨å‘ç°è¿™ä¸ªå¯¹è±¡å«æœ‰ä¸€ä¸ªå¼•ç”¨å¯¹è±¡Hçš„å­—æ®µï¼Œé€ æˆå¯¹è±¡Hä¹Ÿè¢«æ ‡è®°ã€‚æ ‡è®°è¿‡ç¨‹ä¼šæŒç»­ï¼Œç›´åˆ°åº”ç”¨ç¨‹åºæ‰€æœ‰æ ¹æ‰€æœ‰æ£€æŸ¥å®Œæ¯•ã€‚

![2025-07-20-21-02-37.png](./images/2025-07-20-21-02-37.png)

å·²æ ‡è®°çš„å¯¹è±¡ä¸èƒ½è¢«åƒåœ¾å›æ”¶ï¼Œæˆ‘ä»¬è¯´è¿™ç§å¯¹è±¡æ—¶å¯è¾¾çš„ï¼Œå› ä¸ºå¼•ç”¨ç¨‹åºä»£ç å¯é€šè¿‡ä»åœ¨å¼•ç”¨å®ƒçš„å˜é‡æŠµè¾¾ï¼ˆè®¿é—®ï¼‰å®ƒã€‚

- 6ã€CLRçŸ¥é“å“ªäº›å¯¹è±¡å¯ä»¥å¹¸å­˜ï¼Œå“ªäº›å¯ä»¥åˆ é™¤åå°±è¿›å…¥GCå‹ç¼©é˜¶æ®µ
- 7ã€å‹ç¼©æ‰€æœ‰å¹¸å­˜ä¸‹æ¥çš„å¯¹è±¡ï¼Œä½¿å®ƒä»¬å ç”¨è¿ç»­å†…å­˜ç©ºé—´ã€‚ï¼ˆè¿™é‡Œçš„å‹ç¼©æ¥è¿‘äºç¢ç‰‡æ•´ç†ï¼‰
- 8ã€å‹ç¼©åå¯¹è±¡åœ¨å†…å­˜ä¸­çš„ä½ç½®ç§»åŠ¨äº†ï¼Œé‚£å°±æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œéœ€è¦æ›´æ”¹æ ¹å¼•ç”¨å¯¹è±¡çš„ä½ç½®ï¼Œä¸ç„¶é€ æˆå†…å­˜æŸåã€‚æ‰€ä»¥CLRè¦ä»æ¯ä¸ªæ ¹å‡å»æ‰€å¼•ç”¨çš„å¯¹è±¡åœ¨å†…å­˜ä¸­ä¾¿å®œçš„å­—èŠ‚æ•°ï¼Œè¿™æ ·å°±èƒ½ä¿è¯æ¯ä¸ªæ ¹è¿˜æ˜¯å¼•ç”¨å’Œä¹‹å‰ä¸€æ ·çš„å¯¹è±¡ï¼Œåªæ˜¯å¯¹è±¡åœ¨å†…å­˜ä¸­å˜æ¢äº†ä½ç½®ã€‚

![2025-07-20-21-02-53.png](./images/2025-07-20-21-02-53.png)

å¦‚æœCLRåœ¨ä¸€æ¬¡GCåå›æ”¶ä¸äº†å†…å­˜ï¼Œè€Œä¸”è¿›ç¨‹ä¸­æ²¡æœ‰ç©ºé—´åˆ†é…æ–°çš„GCåŒºåŸŸï¼Œè¯´æ˜è¯¥è¿›ç¨‹å†…å­˜è€—å°½ï¼Œè¿™æ—¶ï¼Œnewæ“ä½œä¼šæŠ›å‡ºOutOfMemoryExceptionã€‚

å› ä¸ºè¿™ä¸ªæœºåˆ¶ï¼Œæ‰€ä»¥å‰é¢æŒ‡å‡ºçš„å¿˜è®°é‡Šæ”¾çš„bugä¸å­˜åœ¨äº†ï¼š
- å†…å­˜ä¸å¯èƒ½æ³„éœ²ï¼Œæˆ‘ä»åº”ç”¨ç¨‹åºçš„æ ¹è®¿é—®ä¸äº†ä»»ä½•å¯¹è±¡ï¼Œéƒ½ä¼šåœ¨æŸä¸ªæ—¶é—´è¢«åƒåœ¾å›æ”¶
- ä¸å¯èƒ½å› ä¸ºè®¿é—®è¢«é‡Šæ”¾çš„å†…å­˜è€Œé€ æˆå†…å­˜æŸåï¼Œå› ä¸ºç°åœ¨åªèƒ½å¼•ç”¨æ´»åŠ¨å¯¹è±¡ï¼Œéæ´»åŠ¨å¯¹è±¡æ—¶å¼•ç”¨ä¸äº†çš„

é™æ€å­—æ®µå¼•ç”¨çš„å¯¹è±¡ä¸€ç›´å­˜åœ¨ï¼Œç›´åˆ°ç”¨äºåŠ è½½ç±»å‹çš„AppDomainå¸è½½ä¸ºæ­¢ï¼Œæ‰€ä»¥åº”è¯¥å°½é‡é¿å…ä½¿ç”¨é™æ€å­—æ®µã€‚

#### 21.1.3 åƒåœ¾å›æ”¶å’Œè°ƒè¯•
ä¸€æ—¦æ ¹ç¦»å¼€ä½œç”¨åŸŸï¼Œå®ƒå¼•ç”¨çš„å¯¹è±¡å°±ä¼šå˜å¾—ä¸å¯è¾¾ï¼ŒGCä¼šå›æ”¶å…¶å†…å­˜ï¼Œä¸ä¿è¯å¯¹è±¡åœ¨æ–¹æ³•çš„ç”Ÿå­˜æœŸä¸­è‡ªå§‹è‡³ç»ˆç¬¬å­˜è´§ã€‚
å¦‚ä»¥ä¸‹ä¾‹å­ï¼š
```cs
using System;
using System.Threading;

class Program
{
    public static void Main()
    {
        // åˆ›å»ºæ¯2000æ¯«ç§’å°±è°ƒç”¨ä¸€æ¬¡TimerCallbackæ–¹æ³•çš„Timerå¯¹è±¡
        Timer t = new Timer(TimerCallback, null, 0, 2000);

        // ç­‰å¾…ç”¨æˆ·æŒ‰Enteré”®
        Console.ReadLine();
    }

    private static void TimerCallback(object o)
    {
        // å½“è°ƒç”¨è¯¥æ–¹æ³•ï¼Œ æ˜¾ç¤ºæ—¥æœŸå’Œæ—¶é—´
        Console.WriteLine("In TimerCallback: " + DateTime.Now);

        // å‡ºäºæ¼”ç¤ºç›®çš„ï¼Œå¼ºåˆ¶æ‰§è¡Œä¸€æ¬¡åƒåœ¾å›æ”¶
        GC.Collect();
    }
}
```

![2025-07-26-21-27-25.png](./images/2025-07-26-21-27-25.png)

åªè¦è®¡æ—¶å™¨å¯¹è±¡å­˜åœ¨ï¼Œè®¡æ—¶å™¨å°±åº”è¯¥ä¸€ç›´è§¦å‘ï¼Œæ³¨æ„ï¼ŒTimerCallbackæ–¹æ³•è°ƒç”¨GC.Collect()å¼ºåˆ¶æ‰§è¡Œä¸€æ¬¡åƒåœ¾å›æ”¶ã€‚
å¯ä»¥çœ‹åˆ°ç»“æœæ˜¯åªè°ƒç”¨ä¸€æ¬¡TimerCallbackã€‚

è¿™æ˜¯å› ä¸ºå¼ºåˆ¶æ‰§è¡Œä¸€æ¬¡åƒåœ¾å›æ”¶åï¼Œåƒåœ¾å›æ”¶å™¨ä¼šæ£€æŸ¥åº”ç”¨ç¨‹åºçš„æ ¹ï¼Œå‘ç°åœ¨åˆå§‹åŒ–ä¹‹åï¼ŒMainæ–¹æ³•å†ä¹Ÿæ²¡æœ‰ç”¨è¿‡å˜é‡tï¼Œæ—¢ç„¶åº”ç”¨ç¨‹åºæ²¡æœ‰ä»»ä½•å˜é‡å¼•ç”¨Timerå¯¹è±¡ï¼Œåƒåœ¾å›æ”¶è‡ªç„¶ä¼šå›æ”¶åˆ†é…ç»™å®ƒçš„å†…å­˜ï¼Œè®¡æ—¶å™¨å°±åœæ­¢è§¦å‘äº†ã€‚


![2025-07-26-21-30-34.png](./images/2025-07-26-21-30-34.png)

![2025-07-26-21-48-49.png](./images/2025-07-26-21-48-49.png)

å› ä¸º`new Timer(TimerCallback, null, 0, 2000);`åœ¨åç»­æ²¡æœ‰è¢«å¼•ç”¨ï¼Œæ‰€ä»¥éƒ½ä¸ä¼šç»§ç»­æ‰§è¡Œè®¡æ—¶å™¨ã€‚

æ­£ç¡®ä¿®æ”¹æ–¹å¼ï¼š

![2025-07-26-21-32-31.png](./images/2025-07-26-21-32-31.png)

### 21.2 ä»£ï¼šæå‡æ€§èƒ½
CLRçš„GCæ˜¯åŸºäºä»£çš„åƒåœ¾å›æ”¶å™¨ï¼Œå®ƒå¯¹ä»£ç åšå‡ºäº†ä»¥ä¸‹å‡ ç‚¹å‡è®¾ï¼š
- å¯¹è±¡è¶Šæ–°ï¼Œç”Ÿå­˜æœŸè¶ŠçŸ­
- å¯¹è±¡è¶Šè€ï¼Œç”Ÿå­˜æœŸè¶Šé•¿
- å›æ”¶å †çš„ä¸€éƒ¨åˆ†ï¼Œé€Ÿåº¦å¿«äºå›æ”¶æ•´ä¸ªå †

æ‰˜ç®¡å †åœ¨åˆå§‹åŒ–æ—¶ä¸åŒ…å«å¯¹è±¡ï¼Œæ·»åŠ åˆ°å †çš„å¯¹è±¡ç§°ä¸ºç¬¬0ä»£å¯¹è±¡ã€‚ç®€å•åœ°è¯´ï¼Œç¬¬0ä»£å¯¹è±¡å°±æ˜¯é‚£äº›æ–°æ„é€ çš„å¯¹è±¡ï¼Œåƒåœ¾å›æ”¶å™¨ä»æœªæ£€æŸ¥è¿‡å®ƒä»¬ã€‚

![2025-07-26-22-54-03.png](./images/2025-07-26-22-54-03.png)

CLRåˆå§‹åŒ–æ—¶ä¸ºç¬¬0ä»£å¯¹è±¡é€‰ä¸€ä¸ªé¢„ç®—å®¹é‡ï¼ˆKBä¸ºå•ä½ï¼‰ï¼Œå¦‚æœåˆ†é…ä¸€ä¸ªæ–°å¯¹è±¡é€ æˆç¬¬0ä»£è¶…è¿‡é¢„ç®—ï¼Œå°±å¿…é¡»å¯åŠ¨ä¸€æ¬¡åƒåœ¾å›æ”¶ã€‚

![2025-07-26-22-56-15.png](./images/2025-07-26-22-56-15.png)

ä¸€æ¬¡åƒåœ¾å›æ”¶åï¼Œç¬¬0ä»£å°±ä¸åŒ…å«ä»»ä½•å¯¹è±¡äº†ï¼Œåº”ç”¨ç»§ç»­è¿è¡Œ

![2025-07-26-22-56-58.png](./images/2025-07-26-22-56-58.png)

å†…å­˜å°†åœ¨æŸä¸€æ—¶åˆ»å›æ”¶ï¼Œå‡å®šåˆ†é…æ–°å¯¹è±¡ä¼šé€ æˆç¬¬0ä»£è¶…å‡ºé¢„ç®—ï¼Œé€ æˆå¿…é¡»å¯åŠ¨åƒåœ¾å›æ”¶ã€‚å¼€å§‹åƒåœ¾å›æ”¶æ—¶ï¼Œåƒåœ¾å›æ”¶å™¨å¿…é¡»å†³å®šæ£€æŸ¥å“ªäº›ä»£ã€‚

å·¥å…·ç¬¬ä¸€ä¸ªå‡è®¾è¶Šæ–°çš„å¯¹è±¡æ´»çš„è¶ŠçŸ­ï¼Œæ‰€ä»¥ç¬¬0ä»£åŒ…å«æ›´å¤šåƒåœ¾çš„å¯èƒ½æ€§è¶Šå¤§ï¼Œæ‰€ä»¥å¿½ç•¥ç¬¬1ä»£åªå›æ”¶ç¬¬0ä»£ï¼Œè¿™æ ·åŠ å¿«äº†åƒåœ¾å›æ”¶é€Ÿåº¦ã€‚

å½“ç„¶è€å¯¹è±¡çš„å­—æ®µä¹Ÿå¯èƒ½å¼•ç”¨æ–°å¯¹è±¡ï¼Œä¸ºäº†ç¡®ä¿å †è€å¯¹è±¡çš„å·²æ›´æ–°å­—æ®µè¿›è¡Œæ£€æŸ¥ï¼Œåƒåœ¾å›æ”¶å™¨åˆ©ç”¨JITç¼–è¯‘å™¨å†…éƒ¨ä¸€ä¸ªæœºåˆ¶ï¼Œè¿™ä¸ªæœºåˆ¶åœ¨å¯¹è±¡çš„å¼•ç”¨å­—æ®µå‘ç”Ÿå˜åŒ–æ—¶ï¼Œä¼šè®¾ç½®ä¸€ä¸ªå¯¹åº”çš„ä½æ ‡å¿—ã€‚

![2025-07-26-23-00-52.png](./images/2025-07-26-23-00-52.png)

![2025-07-26-23-01-13.png](./images/2025-07-26-23-01-13.png)

![2025-07-26-23-01-39.png](./images/2025-07-26-23-01-39.png)

å¯ä»¥çœ‹åˆ°ï¼Œç¬¬1ä»£éšç€ç¨‹åºçš„è¿è¡Œæ­£åœ¨ç¼“æ…¢å¢é•¿ã€‚

![2025-07-26-23-01-52.png](./images/2025-07-26-23-01-52.png)

åº”ç”¨ç¨‹åºè¯•å›¾åˆ†é…å¯¹è±¡æ—¶ï¼Œç”±äºç¬¬0ä»£å·²æ»¡ï¼Œå¼€å§‹åƒåœ¾å›æ”¶ï¼Œè¿™æ¬¡å›æ”¶å‘ç°ç¬¬1ä»£å ç”¨å¤ªå¤šå†…å­˜ï¼Œä»¥è‡³äºç”¨å®Œé¢„ç®—ã€‚æ‰€ä»¥è¿™æ¬¡ä¼šæ£€æŸ¥ç¬¬1å’Œç¬¬0ä»£æ‰€æœ‰å¯¹è±¡ã€‚

![2025-07-26-23-04-07.png](./images/2025-07-26-23-04-07.png)

åƒåœ¾å›æ”¶åï¼Œç¬¬0ä»£å¹¸å­˜è€…æå‡ä¸ºç¬¬1ä»£ï¼Œç¬¬1ä»£å¹¸å­˜è€…æå‡è‡³ç¬¬2ä»£ã€‚

æ‰˜ç®¡å †åªæ”¯æŒä¸‰ä»£ï¼ŒCLRåˆå§‹åŒ–ä¼šä¸ºæ¯ä¸€ä»£é€‰æ‹©é¢„ç®—ï¼ŒCLRçš„åƒåœ¾å›æ”¶å™¨æ˜¯è‡ªè°ƒèŠ‚çš„ï¼Œæ„å‘³ç€åƒåœ¾å›æ”¶å™¨ä¼šåœ¨æ‰§è¡Œåƒåœ¾å›æ”¶çš„è¿‡ç¨‹ä¸­äº†è§£ç¨‹åºè¡Œä¸ºï¼Œè‡ªåŠ¨è°ƒæ•´é¢„ç®—ã€‚

å¦‚æœæ²¡æœ‰å›æ”¶åˆ°è¶³å¤Ÿçš„å†…å­˜ï¼Œåƒåœ¾å›æ”¶å™¨ä¼šæ‰§è¡Œä¸€æ¬¡å®Œæ•´å›æ”¶ï¼Œå¦‚æœè¿˜æ˜¯ä¸å¤Ÿï¼Œä¼šæŠ›å‡ºOutOfMemoryException.

![2025-07-26-23-33-10.png](./images/2025-07-26-23-33-10.png)

#### 21.2.1 åƒåœ¾å›æ”¶è§¦å‘æ¡ä»¶
- CLRåœ¨æ£€æµ‹è¶…è¿‡é¢„ç®—æ—¶ä¼šè§¦å‘ä¸€æ¬¡GC
- ä»£ç æ˜¾ç¤ºè°ƒç”¨System.GCçš„é™æ€Collectæ–¹æ³•
- WindowsæŠ¥å‘Šä½å†…å­˜æƒ…å†µ
    - CLRå†…éƒ¨ä½¿ç”¨Win32å‡½æ•°CreateMemoryResourceNotificationå’ŒQueryMemoryResourceNotificationç›‘è§†ç³»ç»Ÿçš„æ€»ä½“å†…å­˜æƒ…å†µ
- CLRæ­£åœ¨å¸è½½AppDomain
    - CLRè®¤ä¸ºå…¶ä¸­ä¸€åˆ‡éƒ½ä¸æ˜¯æ ¹
- CLRæ­£åœ¨å…³é—­
    - CLRåœ¨è¿›ç¨‹æ­£å¸¸ç»ˆæ­¢æ—¶å…³é—­ï¼Œå…³é—­æœŸé—´ï¼ŒCLRè®¤ä¸ºè¿›ç¨‹ä¸­ä¸€åˆ‡éƒ½ä¸æ˜¯æ ¹ï¼Œå›æ”¶è¿›ç¨‹å…¨éƒ¨å†…å­˜

#### 21.2.2 å¤§å¯¹è±¡
è¿˜æœ‰ä¸€ä¸ªæ€§èƒ½æå‡çš„ä¸¾æªï¼ŒCLRå°†å¯¹è±¡æ°›å›´å¤§å¯¹è±¡ï¼ˆ>= 85000å­—èŠ‚ï¼‰å’Œå°å¯¹è±¡ï¼š
- å¤§å¯¹è±¡ä¸æ˜¯åœ¨å°å¯¹è±¡çš„åœ°å€ç©ºé—´åˆ†é…ï¼Œè€Œæ˜¯åœ¨è¿›ç¨‹åœ°å€ç©ºé—´çš„å…¶ä»–åœ°æ–¹åˆ†é…
- å¤§å¯¹è±¡æ€»æ˜¯ç¬¬2ä»£ï¼Œç»ä¸å¯èƒ½æ˜¯ç¬¬0ä»£æˆ–ç¬¬1ä»£ï¼Œæ‰€ä»¥åªèƒ½ä¸ºéœ€è¦é•¿æ—¶é—´å­˜æ´»çš„èµ„æºåˆ›å»ºå¤§å¯¹è±¡ï¼Œåˆ†é…çŸ­æ—¶é—´å­˜æ´»çš„å¤§å¯¹è±¡ä¼šå¯¼è‡´ç¬¬2ä»£æ›´é¢‘ç¹åœ°å›æ”¶ï¼ŒæŸå®³æ€§èƒ½

#### 21.2.5 ç›‘è§†åº”ç”¨ç¨‹åºçš„å†…å­˜ä½¿ç”¨æƒ…å†µ
```cs
using System;

Console.WriteLine("æ€»å†…å­˜ï¼ˆå­—èŠ‚ï¼‰: " + GC.GetTotalMemory(forceFullCollection: false));
Console.WriteLine("ç¬¬0ä»£æ”¶é›†æ¬¡æ•°: " + GC.CollectionCount(0));
Console.WriteLine("ç¬¬1ä»£æ”¶é›†æ¬¡æ•°: " + GC.CollectionCount(1));
Console.WriteLine("ç¬¬2ä»£æ”¶é›†æ¬¡æ•°: " + GC.CollectionCount(2));
```

### 21.3 éœ€è¦ç‰¹æ®Šæ¸…ç†çš„ç±»å‹
æœ‰çš„ç±»å‹é™¤äº†å†…å­˜è¿˜éœ€è¦æœ¬æœºèµ„æºã€‚

ä¾‹å¦‚System.IO.FileStreamç±»å‹éœ€è¦æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ï¼ˆæœ¬æœºèµ„æºï¼‰å¹¶ä¿å­˜æ–‡ä»¶å¥æŸ„ã€‚ç„¶åï¼Œç±»å‹çš„Readå’ŒWriteæ–¹æ³•ç”¨å¥æŸ„æ“ä½œæ–‡ä»¶ã€‚

åŒ…å«æœ¬æœºèµ„æºçš„ç±»å‹è¢«GCæ—¶ï¼ŒGCä¼šå›æ”¶å¯¹è±¡åœ¨æ‰˜ç®¡å †ä¸­çš„å†…å­˜ï¼Œè¿™æ ·ä¼šé€ æˆæœ¬æœºèµ„æºï¼ˆGCå¯¹å®ƒä¸€æ— æ‰€çŸ¥ï¼‰çš„æ³„éœ²ã€‚æ‰€ä»¥CLRæä¾›ç§°ä¸ºç»ˆç»“çš„æœºåˆ¶ï¼Œå…è®¸å¯¹è±¡åœ¨è¢«åˆ¤å®šä¸ºåƒåœ¾åï¼Œåœ¨å¯¹è±¡å†…å­˜è¢«å›æ”¶å‰æ‰§è¡Œä¸€äº›ä»£ç ã€‚

ä»»ä½•åŒ…è£…äº†æœ¬æœºèµ„æºï¼ˆæ–‡ä»¶ã€ç½‘ç»œè¿æ¥ã€å¥—æ¥å­—ã€äº’æ–¥ä½“ï¼‰çš„ç±»å‹éƒ½æ”¯æŒç»ˆç»“ã€‚

System.Objectå®šä¹‰äº†å—ä¿æŠ¤æ–¹çš„è™šæ–¹æ³•Finalizeã€‚åƒåœ¾å›æ”¶å™¨åˆ¤å®šå¯¹è±¡æ—¶åƒåœ¾åï¼Œä¼šè°ƒç”¨å¯¹è±¡çš„Finalizeæ–¹æ³•ï¼ˆå¦‚æœé‡å†™å°±ä¼šè°ƒç”¨ï¼‰ã€‚

C#è¦æ±‚åœ¨ç±»åå‰æ·»åŠ ~ç¬¦å·å®šä¹‰Finalizeæ–¹æ³•ï¼š
```cs
internal sealed class SomeType{
    // è¿™æ˜¯ä¸€ä¸ªFinalizeæ–¹æ³•
    ~SomeType(){
        // è¿™é‡Œçš„ä»£ç ä¼šè¿›å…¥Finalizeæ–¹æ³•
    }
}
```

CLRä¸ä¿è¯å¤šä¸ªFinalizeæ–¹æ³•çš„è°ƒç”¨é¡ºåºï¼Œæ‰€ä»¥åœ¨Finalizeæ–¹æ³•ä¸­ä¸è¦è®¿é—®å®šä¹‰äº†Finalizeæ–¹æ³•çš„å…¶ä»–ç±»å‹çš„å¯¹è±¡ï¼Œå“ªäº›å¯¹è±¡å¯èƒ½å·²ç»ç»ˆç»“ã€‚

Finalizeæ–¹æ³•é—®é¢˜è¾ƒå¤šï¼Œä½¿ç”¨éœ€è¦è°¨æ…ã€‚å®ƒä»¬æ˜¯ä¸ºé‡Šæ”¾æœ¬æœºèµ„æºè€Œè®¾è®¡çš„ï¼Œå¼ºçƒˆå»ºè®®ä¸è¦é‡å†™Objectçš„Finalizeæ–¹æ³•ã€‚ä½¿ç”¨Microsoftåœ¨FCLä¸­æä¾›çš„è¾…åŠ©ç±»ï¼Œè¿™äº›è¾…åŠ©ç±»é‡å†™äº†Finalizeæ–¹æ³•å¹¶æ·»åŠ ä¸€äº›ç‰¹æ®Šçš„CLRâ€œé­”æ³•â€ã€‚æˆ‘ä»¬å¯ä»¥ä»è¿™äº›è¾…åŠ©ç±»æ´¾ç”Ÿå‡ºè‡ªå·±çš„ç±»ï¼Œä»è€Œç»§æ‰¿CLRçš„é­”æ³•ã€‚

åˆ›å»ºå°è£…äº†æœ¬æœºèµ„æºçš„æ‰˜ç®¡ç±»å‹æ—¶ï¼Œåº”è¯¥å…ˆä»System.Runtime.InteropServices.SafeHandleè¿™ä¸ªç‰¹æ®ŠåŸºç±»æ´¾ç”Ÿå‡ºä¸€ä¸ªç±»ã€‚
```cs
public abstract class SafeHandle : CriticalFinalizerObject, IDisposable{
    ...
}
```

#### 21.3.1 ä½¿ç”¨åŒ…è£…äº†æœ¬æœºèµ„æºçš„ç±»å‹
ä»¥System.IO.FileStreamç±»ä¸ºä¾‹ï¼Œå¯åˆ©ç”¨å®ƒæ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ï¼Œä»æ–‡ä»¶ä¸­è¯»å–å­—èŠ‚ï¼Œå‘æ–‡ä»¶å†™å…¥å­—èŠ‚ï¼Œç„¶åå…³é—­æ–‡ä»¶ã€‚

```cs
using System;
using System.IO;

public static class Program {
    public static void Main() {
        // åˆ›å»ºè¦å†™å…¥ä¸´æ—¶æ–‡ä»¶çš„å­—èŠ‚
        Byte[] bytesToWrite = new Byte[] { 1, 2, 3, 4, 5 };

        // åˆ›å»ºä¸´æ—¶æ–‡ä»¶
        FileStream fs = new FileStream("Temp.dat", FileMode.Create);

        // å°†å­—èŠ‚å†™å…¥ä¸´æ—¶æ–‡ä»¶
        fs.Write(bytesToWrite, 0, bytesToWrite.Length);

        // åˆ é™¤ä¸´æ—¶æ–‡ä»¶ åˆ é™¤ä¸éœ€è¦å¥æŸ„
        File.Delete("Temp.dat"); // æŠ›å‡º IOException å¼‚å¸¸
    }
}

```

ä¸€èˆ¬ä¸Šè¿°ä»£ç ä¼šæŠ¥é”™ï¼Œå› ä¸ºæ‰§è¡Œåˆ é™¤æ–¹æ³•çš„æ—¶å€™è¯¥æ–‡ä»¶å¤§æ¦‚ç‡è¿˜æ‰“å¼€ç€ã€‚

å¯èƒ½æ‰§è¡ŒæˆåŠŸæ˜¯å› ä¸ºï¼šå¦‚æœåƒåœ¾å›æ”¶åˆšå¥½åœ¨è°ƒç”¨Writeä¹‹åï¼Œè°ƒç”¨Deleteä¹‹å‰å‘ç”Ÿï¼Œé‚£ä¹ˆFileStreamçš„SafeFileHandleå­—æ®µçš„Finalizeæ–¹æ³•å°±ä¼šè¢«è°ƒç”¨ï¼Œå°±ä¼šå…³é—­æ–‡ä»¶ï¼ŒéšåDeleteæ“ä½œä¹Ÿå°±å¯ä»¥æ­£å¸¸è¿è¡Œã€‚ä½†å‘ç”Ÿè¿™ç§æ¦‚ç‡å¾ˆå°ã€‚

ç±»å¦‚æœå‘å…è®¸ä½¿ç”¨è€…æ§åˆ¶ç±»æ‰€åŒ…è£…çš„æœ¬æœºèµ„æºçš„ç”Ÿå­˜æœŸï¼Œå°±å¿…é¡»å®ç°IDisposableæ¥å£ã€‚

```cs
using System;
using System.IO;

public static class Program {
    public static void Main() {
        // åˆ›å»ºè¦å†™å…¥ä¸´æ—¶æ–‡ä»¶çš„å­—èŠ‚
        Byte[] bytesToWrite = new Byte[] { 1, 2, 3, 4, 5 };

        // åˆ›å»ºä¸´æ—¶æ–‡ä»¶
        FileStream fs = new FileStream("Temp.dat", FileMode.Create);

        // å°†å­—èŠ‚å†™å…¥ä¸´æ—¶æ–‡ä»¶
        fs.Write(bytesToWrite, 0, bytesToWrite.Length);

        // å†™å…¥ç»“æŸåæ˜¾ç¤ºå…³é—­æ–‡ä»¶
        fs.Dispose();

        // åˆ é™¤ä¸´æ—¶æ–‡ä»¶
        File.Delete("Temp.dat"); 
    }
}
```

ç°åœ¨ï¼Œå½“è°ƒç”¨Deleteæ–¹æ³•æ—¶ï¼ŒWindowå‘ç°è¯¥æ–‡ä»¶æ²¡æœ‰æ‰“å¼€ï¼Œæ‰€ä»¥èƒ½æˆåŠŸåˆ é™¤å®ƒã€‚

æœ¬æœºèµ„æºçš„æ¸…ç†æœ€ç»ˆä¼šå‘ç”Ÿï¼Œè°ƒç”¨Disposeåªæ˜¯æ§åˆ¶è¿™ä¸ªæ¸…ç†åŠ¨ä½œçš„å‘ç”Ÿæ—¶é—´ã€‚å¦å¤–è°ƒç”¨Disposeä¸ä¼šå°†æ‰˜ç®¡å¯¹è±¡ä»æ‰˜ç®¡å †ä¸­åˆ é™¤ï¼Œåªæœ‰åœ¨åƒåœ¾å›æ”¶ä¹‹åï¼Œæ‰˜ç®¡å †ä¸­çš„å†…å­˜æ‰ä¼šå¾—ä»¥å›æ”¶ã€‚

ä¸€èˆ¬ä¸èµæˆåœ¨ä»£ç ä¸­æ˜¾ç¤ºè°ƒç”¨Disposeã€‚Disposeçš„è®¾è®¡è§„èŒƒæŒ‡å‡ºDisposeä¸ä¸€å®šè¦çº¿ç¨‹å®‰å…¨ï¼ŒåŸå› æ˜¯ä»£ç åªæœ‰åœ¨ç¡®å®šæ²¡æœ‰åˆ«çš„çº¿ç¨‹ä½¿ç”¨å¯¹è±¡æ—¶æ‰åº”è°ƒç”¨Disposeã€‚

å¦‚æœå†³å®šæ˜¾ç¤ºè°ƒç”¨Disposeï¼Œå¼ºçƒˆå»ºè®®å°†è°ƒç”¨æ”¾åˆ°ä¸€ä¸ªå¼‚å¸¸å¤„ç†finallyå—ä¸­ï¼š
```cs
public static class Program {
    public static void Main() {
        // åˆ›å»ºè¦å†™å…¥ä¸´æ—¶æ–‡ä»¶çš„å­—èŠ‚
        Byte[] bytesToWrite = new Byte[] { 1, 2, 3, 4, 5 };

        // åˆ›å»ºä¸´æ—¶æ–‡ä»¶
        FileStream fs = new FileStream("Temp.dat", FileMode.Create);
        try{
            // å°†å­—èŠ‚å†™å…¥ä¸´æ—¶æ–‡ä»¶
            fs.Write(bytesToWrite, 0, bytesToWrite.Length);
        }
        finally{
            // å†™å…¥ç»“æŸåæ˜¾ç¤ºå…³é—­æ–‡ä»¶
            if(fs != null) 
                fs.Dispose();
        }
        // åˆ é™¤ä¸´æ—¶æ–‡ä»¶
        File.Delete("Temp.dat"); 
    }
}
```

C#æä¾›äº†ä¸€ä¸ªusingè¯­å¥ï¼Œå…è®¸ç”¨ç®€åŒ–çš„è¯­æ³•è·å¾—å’Œä¸Šè¿°ä»£ç ç›¸åŒçš„ç»“æœã€‚

```cs
public static class Program {
    public static void Main() {
        // åˆ›å»ºè¦å†™å…¥ä¸´æ—¶æ–‡ä»¶çš„å­—èŠ‚
        Byte[] bytesToWrite = new Byte[] { 1, 2, 3, 4, 5 };

        // åˆ›å»ºä¸´æ—¶æ–‡ä»¶
        using (FileStream fs = new FileStream("Temp.dat", FileMode.Create)){
            // å°†å­—èŠ‚å†™å…¥ä¸´æ—¶æ–‡ä»¶
            fs.Write(bytesToWrite, 0, bytesToWrite.Length);
        }

        // åˆ é™¤ä¸´æ—¶æ–‡ä»¶
        File.Delete("Temp.dat"); 
    }
}
```

#### 21.3.2 ä¸€ä¸ªæœ‰è¶£çš„ä¾èµ–æ€§é—®é¢˜
FileStreamç±»å‹å…è®¸ç”¨æˆ·æ‰“å¼€æ–‡ä»¶è¿›è¡Œè¯»å†™ã€‚ä¸ºæé«˜æ€§èƒ½ï¼Œè¯¥ç±»å‹çš„å®ç°åˆ©ç”¨å†…å­˜ç¼“å†²åŒºï¼Œåªæœ‰ç¼“å†²åŒºæ»¡ï¼Œç±»å‹æ‰å°†ç¼“å†²åŒºä¸­çš„æ•°æ®åˆ·å…¥æ–‡ä»¶ã€‚

FileStreamç±»å‹åªæ”¯æŒå­—èŠ‚å†™å…¥ï¼Œå†™å…¥å­—ç¬¦å’Œå­—ç¬¦ä¸²å¯ä»¥ä½¿ç”¨ä¸€ä¸ªSystem.IO.StreamWriter
```cs
FileStream fs = new FileStream("DataFile.dat", FileMode.Create);
StreamWriter sw = new StreamWriter(fs);
sw.Write("Hi there");

// ä¸è¦å¿˜è®°å†™ä¸‹é¢è¿™ä¸ª Dispose è°ƒç”¨
sw.Dispose(); // ä¼šè‡ªåŠ¨ Dispose æ‰ fs

```

ä¸éœ€è¦åœ¨FileStreamå¯¹è±¡ä¸Šæ˜¾ç¤ºè°ƒç”¨Disposeï¼Œå› ä¸ºStreamWriterä¼šè°ƒç”¨

åƒåœ¾å›æ”¶å™¨ä¸ä¿è¯å¯¹è±¡çš„ç»ˆç»“é¡ºåºï¼Œæ‰€ä»¥å¦‚æœFileStreamå¯¹è±¡å…ˆç»ˆç»“ï¼Œå…ˆå…³é—­æ–‡ä»¶ï¼Œç„¶åå½“StreamWriterå¯¹è±¡ç»ˆç»“æ—¶ï¼Œä¼šè¯•å›¾å‘å·²å…³é—­çš„æ–‡ä»¶å†™å…¥æ•°æ®ï¼Œé€ æˆæŠ›å‡ºå¼‚å¸¸ã€‚ç›¸åï¼Œå¦‚æœæ˜¯StreamWriterå…ˆç»ˆç»“ï¼Œæ•°æ®ä¼šå®‰å…¨å†™å…¥æ–‡ä»¶ã€‚

è®©åƒåœ¾å›æ”¶å™¨ä»¥ç‰¹å®šé¡ºåºç»ˆç»“å¯¹è±¡æ—¶ä¸å¯èƒ½çš„ï¼Œå› ä¸ºä¸åŒå¯¹è±¡å¯èƒ½åŒ…å«ç›¸äº’ä¹‹é—´çš„å¼•ç”¨ï¼Œåƒåœ¾å›æ”¶å™¨æ— æ³•æ­£ç¡®çŒœå‡ºè¿™äº›å¯¹è±¡çš„ç»ˆç»“é¡ºåºã€‚Microsoftçš„è§£å†³æ–¹æ¡ˆæ˜¯ï¼šStreamWriterç±»å‹ä¸æ”¯æŒç»ˆç»“ï¼Œæ‰€ä»¥æ°¸è¿œä¸ä¼šå°†å®ƒçš„ç¼“å†²åŒºä¸­çš„æ•°æ®flushåˆ°åº•å±‚FileStreamå¯¹è±¡ã€‚æ‰€ä»¥å¼€å‘äººå‘˜éœ€è¦æ˜¾ç¤ºè°ƒç”¨å¯¹StreamWriterçš„Disposeã€‚

å†æ¬¡å¼ºè°ƒï¼šDisposeä¸ä¼šæ‰§è¡Œç»ˆç»“ï¼Œè€Œæ˜¯åƒåœ¾å›æ”¶å‰ä¼šæ‰§è¡Œç»ˆç»“ã€‚

#### 21.3.4 ç»ˆç»“çš„å†…éƒ¨å·¥ä½œåŸç†
åˆ›å»ºæ–°å¯¹è±¡æ—¶ï¼Œnewæ“ä½œç¬¦ä¼šä»å †ä¸­åˆ†é…å†…å­˜ï¼Œå¦‚æœå¯¹è±¡çš„ç±»å‹å®šä¹‰äº†Finalizeæ–¹æ³•ï¼Œé‚£ä¹ˆåœ¨æ”¹ç±»å‹çš„å®ä¾‹æ„é€ å™¨è¢«è°ƒç”¨ä¹‹å‰ï¼Œä¼šæŒ‡å‘è¯¥å¯¹è±¡çš„æŒ‡é’ˆæ”¾åˆ°ä¸€ä¸ªç»ˆç»“åˆ—è¡¨ã€‚åˆ—è¡¨ä¸­çš„æ¯ä¸€é¡¹éƒ½æŒ‡å‘ä¸€ä¸ªå¯¹è±¡â€”â€”â€”â€”å›æ”¶è¯¥å¯¹è±¡çš„å†…å­˜å‰åº”è°ƒç”¨å®ƒçš„Finalizeæ–¹æ³•ã€‚

![2025-07-27-21-28-27.png](./images/2025-07-27-21-28-27.png)

B,E,G,H,I,Jè¢«åˆ¤å®šä¸ºåƒåœ¾ï¼Œåƒåœ¾å›æ”¶å™¨æ‰«æç»ˆç»“åˆ—è¡¨ä»¥æŸ¥æ‰¾å¯¹è¿™äº›å¯¹è±¡çš„å¼•ç”¨ï¼Œæ‰¾åˆ°ä¸€ä¸ªå¼•ç”¨åï¼Œè¯¥å¼•ç”¨ä¼šä»ç»ˆç»“åˆ—è¡¨ä¸­ç§»é™¤ï¼Œå¹¶é™„åŠ åˆ°freachableé˜Ÿåˆ—ã€‚é˜Ÿåˆ—ä¸­çš„æ¯ä¸ªå¼•ç”¨éƒ½ä»£è¡¨å…¶Finalizeæ–¹æ³•å·²å‡†å¤‡å¥½è°ƒç”¨çš„ä¸€ä¸ªå¯¹è±¡ã€‚

![2025-07-27-21-30-28.png](./images/2025-07-27-21-30-28.png)

å¯¹è±¡B,G,Hå ç”¨çš„å†…å­˜å·²è¢«å›æ”¶ï¼Œå› ä¸ºä»–ä»¬æ²¡æœ‰Finalizeæ–¹æ³•ã€‚ä½†å¯¹è±¡E,I,Jå ç”¨çš„å†…å­˜æš‚æ—¶ä¸èƒ½å›æ”¶ï¼Œå› ä¸ºä»–ä»¬çš„Finalizeæ–¹æ³•è¿˜æ²¡æœ‰è°ƒç”¨ã€‚

ä¸€ä¸ªç‰¹æ®Šçš„é«˜ä¼˜å…ˆçº§CLRçº¿ç¨‹ä¸“é—¨è°ƒç”¨Finalizeæ–¹æ³•ã€‚

å½“åƒåœ¾å›æ”¶å™¨å°†å¯¹è±¡çš„å¼•ç”¨ä»ç»ˆç»“åˆ—è¡¨ç§»è‡³freachableé˜Ÿåˆ—æ—¶ï¼Œå¯¹è±¡ä¸å†è¢«è§†ä¸ºåƒåœ¾ï¼Œä¸èƒ½å›æ”¶å®ƒçš„å†…å­˜ï¼Œå¯¹è±¡è¢«è§†ä¸ºåƒåœ¾åˆå˜å¾—ä¸æ˜¯åƒåœ¾ï¼Œå¯¹è±¡å¤æ´»äº†ã€‚

ç°åœ¨ç‰¹æ®Šçš„ç»ˆç»“çº¿ç¨‹æƒ…å†µfreachableå¯¹è±¡ï¼Œæ‰§è¡Œæ¯ä¸ªå¯¹è±¡çš„Finalizeæ–¹æ³•ã€‚ä¸‹æ¬¡å¯¹è€ä¸€ä»£è¿›è¡Œåƒåœ¾å›æ”¶æ—¶ï¼Œä¼šå‘ç°å·²ç»ˆç»“çš„å¯¹è±¡æˆä¸ºçœŸæ­£çš„åƒåœ¾ã€‚æ‰€ä»¥è¿™äº›å¯¹è±¡çš„å†…å­˜ä¼šç›´æ¥å›æ”¶ã€‚

![2025-07-27-21-34-40.png](./images/2025-07-27-21-34-40.png)

## 22 CLRå¯„å®¿å’ŒAppDomain
### 22.1 CLRå¯„å®¿
.net coreåå˜åŒ–å¾ˆå¤§ï¼Œè¿™é‡Œä¸ä»¥ä¹¦æœ¬ä¸ºå‡†ã€‚

CLRï¼ˆCommon Language Runtimeï¼‰å¯„å®¿ï¼Œæ˜¯æŒ‡åˆ›å»ºå¹¶åˆå§‹åŒ–ä¸€ä¸ª CLR å®ä¾‹ï¼ŒæŠŠå®ƒâ€œåµŒå…¥â€è¿›æŸä¸ªåº”ç”¨ç¨‹åºè¿›ç¨‹ä¸­è¿è¡Œ .NET ä»£ç ã€‚

é€šä¿—æ¥è¯´ï¼š
â€œä¸æ˜¯ CLR å¯åŠ¨ä½ çš„ç¨‹åºï¼Œè€Œæ˜¯ä½ çš„ç¨‹åºå¯åŠ¨å¹¶æ§åˆ¶ CLRã€‚â€

ä¾‹å¦‚ç”¨ C++ å†™äº†ä¸€ä¸ªåŸç”Ÿç¨‹åºï¼Œæƒ³åœ¨å…¶ä¸­è¿è¡Œä¸€äº› C# è„šæœ¬æˆ–é€»è¾‘ï¼š
- åŠ è½½ .NET CLR
- åˆå§‹åŒ– AppDomain
- æ‰§è¡Œæ‰˜ç®¡ä»£ç 
- è·å–ç»“æœ

è¿™å°±å«åšâ€œå¯„å®¿ CLRâ€ã€‚

https://github.com/dotnet/samples/tree/main/core/hosting



### 22.2 AppDomain
å¯ä»¥ç†è§£æ˜¯ä¸€ä¸ªWindowè¿›ç¨‹å¯ä»¥è¿è¡Œå¤šä¸ªappï¼Œæ¯ä¸ªappå°±æ˜¯ä¸€ä¸ªAppDomainéš”ç¦»å¼€è€Œå®ç°çš„ã€‚

å› ä¸ºæ˜¯frameworkçš„å†…å®¹ï¼Œdotnet coreä¸å†æ”¯æŒå®Œæ•´çš„AppDomainï¼Œæ‰€ä»¥è¿™é‡Œä¹Ÿä¸è®°å½•äº†ã€‚

é‡ç‚¹å…³æ³¨AssemblyLoadContextã€‚


æˆ‘åˆ›å»ºä¸€ä¸ª.NET Core Web API é¡¹ç›®ï¼Œè¿è¡Œæ—¶ï¼Œæ‰€åœ¨çš„åº”ç”¨ç¨‹åºå°±æ˜¯ä¸€ä¸ªé»˜è®¤çš„ AppDomainï¼Œä½†è¿™ä¸ª AppDomain æ˜¯ å”¯ä¸€çš„ã€ä¸å¯è‡ªå®šä¹‰åˆ›å»ºæˆ–å¸è½½çš„ã€‚


## 23 ç¨‹åºé›†åŠ è½½å’Œåå°„
### 23.1 ç¨‹åºé›†åŠ è½½
JITç¼–è¯‘å™¨å°†æ–¹æ³•çš„ILä»£ç ç¼–è¯‘æˆæœ¬æœºä»£ç æ—¶ï¼Œä¼šæŸ¥çœ‹ILä»£ç ä¸­å¼•ç”¨äº†å“ªäº›ç±»å‹ã€‚åœ¨è¿è¡Œæ—¶ï¼ŒJITç¼–è¯‘å™¨åˆ©ç”¨ç¨‹åºé›†çš„TypeRefå’ŒAssemblyRefå…ƒæ•°æ®è¡¨ç¡®å®šå“ªä¸€ç¨‹åºé›†å®šä¹‰äº†æ‰€å¼•ç”¨çš„ç±»å‹ã€‚

```cs
var result = new MyService().DoSomething();
```

ä¸Šé¢è¿™ä¸ªä»£ç ç¼–è¯‘åä¼šæ˜¯è¿™æ ·çš„æŒ‡ä»¤

```cs
newobj instance void MyNamespace.MyService::.ctor()
callvirt instance int32 MyNamespace.MyService::DoSomething()
```
IL ä¸­çš„ MyNamespace.MyService æ˜¯é€šè¿‡ TypeRefï¼ˆç±»å‹å¼•ç”¨ï¼‰ æ ‡è®°çš„ï¼Œè€Œå®šä¹‰ MyService çš„ç¨‹åºé›†ï¼Œæ˜¯é€šè¿‡ AssemblyRefï¼ˆç¨‹åºé›†å¼•ç”¨ï¼‰ ç¡®å®šçš„ã€‚

å½“è¿è¡Œåˆ°è¿™æ®µä»£ç æ—¶ï¼ŒJIT ä¼šï¼š
- çœ‹ TypeRef è¡¨ï¼Œæ‰¾å‡ºå¯¹åº”çš„ç±»å‹ï¼ˆæ¯”å¦‚ token: 0x0100001Dï¼‰
- ä» AssemblyRef è¡¨ä¸­æ‰¾å‡ºå®šä¹‰è¯¥ç±»å‹çš„ç¨‹åºé›†
- è°ƒç”¨ CLR çš„åŠ è½½æœºåˆ¶ï¼ˆç”¨ AssemblyLoadContextï¼‰åŠ è½½è¯¥ç¨‹åºé›†ï¼ˆå¦‚æœå°šæœªåŠ è½½ï¼‰
- ç¼–è¯‘å¹¶ç”Ÿæˆæœ¬åœ°ä»£ç 

![2025-07-29-22-03-39.png](./images/2025-07-29-22-03-39.png)


é¡¹ç›®ä¹‹é—´å¯ä»¥ç›´æ¥å¼•ç”¨ï¼Œç¼–è¯‘æ—¶å°±ä¼šç»‘å®šå’ŒåŠ è½½ï¼Œä½†æœ‰äº›åœºæ™¯ä¸‹ï¼Œä½ æ— æ³•æå‰â€œå¼•ç”¨â€ï¼Œå¿…é¡»åœ¨è¿è¡Œæ—¶åŠ¨æ€åŠ è½½ï¼Œè¿™æ—¶å€™æ‰éœ€è¦ Assembly.Loadã€‚


å¯èƒ½éœ€è¦æ‰‹åŠ¨åŠ è½½ç¨‹åºé›†çš„å…¸å‹åœºæ™¯ï¼š
- å…è®¸ç”¨æˆ·æˆ–ç¬¬ä¸‰æ–¹å¼€å‘è€…å†™è‡ªå·±çš„æ’ä»¶ï¼ˆDLLï¼‰ï¼Œä½ åœ¨è¿è¡Œæ—¶åŠ è½½è¿™äº›ç¨‹åºé›†å¹¶è°ƒç”¨å…¶ç±»å‹/æ–¹æ³•
    ```cs
    // åŠ è½½æ’ä»¶
    var asm = Assembly.LoadFrom("Plugins/MyPlugin.dll");
    // æŸ¥æ‰¾å®ç°äº† IPlugin æ¥å£çš„ç±»
    var type = asm.GetTypes().First(t => typeof(IPlugin).IsAssignableFrom(t));
    // å®ä¾‹åŒ–å¹¶è°ƒç”¨
    var plugin = (IPlugin)Activator.CreateInstance(type);
    plugin.Execute();
    ```
- åŠ è½½ç¬¬ä¸‰æ–¹ DLLï¼ˆéƒ¨ç½²æ—¶æ‰å†³å®šï¼‰
- åå°„æ¡†æ¶ / è„šæœ¬å¼•æ“ / IoC å®¹å™¨å®ç°
    ```cs
    var asm = Assembly.Load("MyApp.Handlers");
    var types = asm.GetTypes().Where(t => t.Name.EndsWith("Handler"));
    ```

åœ¨å†…éƒ¨ï¼ŒLoadå¯¼è‡´CLRå‘ç¨‹åºé›†åº”ç”¨ä¸€ä¸ªç‰ˆæœ¬ç»‘å®šé‡å®šå‘ç­–ç•¥ï¼Œå¹¶åœ¨GACï¼ˆå…¨å±€ç¨‹åºé›†ç¼“å­˜ï¼‰ä¸­æŸ¥æ‰¾ç¨‹åºé›†ã€‚å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œå°±ç›´æ¥å»åº”ç”¨ç¨‹åºçš„åŸºç›®å½•ã€ç§æœ‰è·¯å¾„å­ç›®å½•å’Œcodebaseä½ç½®æŸ¥æ‰¾ã€‚

å¦‚æœLoadæ‰¾åˆ°ï¼Œä¼šå·²åŠ è½½çš„é‚£ä¸ªç¨‹åºé›†çš„ä¸€ä¸ªAssemblyå¯¹è±¡çš„å¼•ç”¨ï¼Œå¦‚æœæ²¡æ‰¾åˆ°ï¼Œä¼šæŠ›å‡ºSystem.IO.FileNotFoundExceptionå¼‚å¸¸ã€‚

Assemblyçš„Loadæ–¹æ³•æ—¶å°†ç¨‹åºé›†åŠ è½½åˆ°AppDomainçš„é¦–é€‰æ–¹å¼ã€‚è¿˜æœ‰ä¸€ç›´æ–¹å¼æ˜¯LoadFormæ–¹æ³•ï¼ˆå†…éƒ¨ä¹Ÿæ˜¯è°ƒç”¨Loadæ–¹æ³•ï¼‰ã€‚

```cs
// é€šè¿‡è·¯å¾„åŠ è½½ç¨‹åºé›†
Assembly.LoadFrom("ç»å¯¹è·¯å¾„/MyLibrary.dll");
```

å¦‚æœLoadFromä¼ é€’çš„æ˜¯ä¸€ä¸ªInternetä½ç½®ï¼ŒCLRä¼šä¸‹è½½æ–‡ä»¶ï¼ŒæŠŠå®ƒå®‰è£…åˆ°ç”¨æˆ·çš„ä¸‹è½½ç¼“å­˜ä¸­ï¼Œå†ä»é‚£åŠ è½½æ–‡ä»¶ã€‚è¿˜å¯ä»¥è°ƒç”¨UnsafeLoadFromï¼Œå®ƒèƒ½å¤ŸåŠ è½½ä»ç½‘ä¸Šä¸‹è½½çš„ç¨‹åºé›†ï¼ŒåŒæ—¶ç»•è¿‡ä¸€äº›å®‰å…¨æ£€æŸ¥ã€‚

é€šè¿‡LoadFileåŠ è½½ç¨‹åºé›†æ—¶ï¼ŒCLRä¸ä¼šè‡ªåŠ¨è§£æä»»ä½•ä¾èµ–æ€§é—®é¢˜ï¼šä»£ç å¿…é¡»å‘AppDomainçš„AssemblyResolveäº‹ä»¶ç™»è®°ï¼Œå¹¶è®©äº‹ä»¶å›è°ƒæ–¹æ³•æ˜¾ç¤ºåœ°åŠ è½½ä»»ä½•ä¾èµ–çš„ç¨‹åºé›†ã€‚
æ¯”å¦‚`var asm = Assembly.LoadFile(@"C:\MyPlugins\MyPlugin.dll");`è¿™åŠ è½½äº† MyPlugin.dll ï¼Œä½†å¦‚æœè¿™ä¸ªæ’ä»¶ä¾èµ–äº† Newtonsoft.Json.dllï¼Œä¸ä¼šè‡ªåŠ¨å»æ‰¾å’ŒåŠ è½½å®ƒã€‚
æˆ‘ä»¬å¿…é¡» è‡ªå·±å‘Šè¯‰ CLRï¼šå¦‚æœæ‰¾ä¸åˆ°ä¾èµ–ï¼Œæˆ‘æ¥å¸®ä½ åŠ è½½ã€‚
```cs
// ï¼Œå½“ CLR æ‰¾ä¸åˆ°ä¾èµ–æ—¶ï¼Œå°±ä¼šè§¦å‘è¿™ä¸ªäº‹ä»¶ï¼Œå°±å¯ä»¥ç”¨è‡ªå·±çš„é€»è¾‘æ¥å¸®å®ƒæ‰¾åˆ°å¹¶åŠ è½½æ­£ç¡®çš„ä¾èµ–
AppDomain.CurrentDomain.AssemblyResolve += (sender, args) =>
{
    // æå–ä¾èµ–ç¨‹åºé›†å
    var assemblyName = new AssemblyName(args.Name).Name;

    // è‡ªå®šä¹‰é€»è¾‘å»æ‰¾å¯¹åº”çš„ä¾èµ– DLL è·¯å¾„
    var path = Path.Combine(@"C:\Plugins\", assemblyName + ".dll");

    if (File.Exists(path))
    {
        return Assembly.LoadFrom(path);
    }

    return null;
};
```


å¦‚æœæ„å»ºçš„ä¸€ä¸ªå·¥å…·åªæƒ³é€šè¿‡åå°„æ¥åˆ†æç¨‹åºé›†çš„å…ƒæ•°æ®ï¼Œå¹¶å¸Œæœ›ç¡®ä¿ç¨‹åºé›†ä¸­çš„ä»»ä½•ä»£ç éƒ½ä¸ä¼šæ‰§è¡Œï¼Œé‚£ä¹ˆåŠ è½½ç¨‹åºé›†çš„æœ€ä½³æ–¹å¼å°±æ˜¯ä½¿ç”¨Assemblyçš„ReflectionOnlyLoadFromæ–¹æ³•æˆ–ä½¿ç”¨Assemblyçš„ReflectionOnlyLoadæ–¹æ³•ã€‚

ä¸Šé¢è¿™ä¸¤ä¸ªå·²ç»ä¸ç”¨äº†ï¼Œå®˜æ–¹æ¨èçš„æ–¹å¼æ˜¯ï¼šSystem.Reflection.MetadataLoadContext
ä¼˜ç‚¹ï¼š
- åŠ è½½ç¨‹åºé›†è¿›è¡Œåå°„åˆ†æ
- ä¸ä¼šæ‰§è¡Œä»»ä½• IL
- ä¸ä¼šè§¦å‘é™æ€æ„é€ å™¨ / JIT ç¼–è¯‘
- å®‰å…¨ã€å¯æ§

```cs
System.Reflection.MetadataLoadContext
```

### 23.2 ä½¿ç”¨åå°„æ„å»ºåŠ¨æ€å¯æ‰©å±•åº”ç”¨ç¨‹åº
å…ƒæ•°æ®æ˜¯ç”¨ä¸€ç³»åˆ—è¡¨æ¥å­˜å‚¨çš„ã€‚ç”Ÿæˆç¨‹åºé›†æˆ–æ¨¡å—æ—¶ï¼Œç¼–è¯‘å™¨ä¼šåˆ›å»ºä¸€ä¸ªç±»å‹å®šä¹‰è¡¨ã€ä¸€ä¸ªå­—æ®µå®šä¹‰è¡¨ã€ä¸€ä¸ªæ–¹æ³•å®šä¹‰è¡¨ä»¥åŠå…¶ä»–è¡¨ã€‚åˆ©ç”¨System.Reflectionå‘½åç©ºé—´ä¸­åŒ…å«çš„ç±»å‹ï¼Œå¯ä»¥å†™ä»£ç æ¥åå°„ï¼ˆè§£æï¼‰è¿™äº›å…ƒæ•°æ®è¡¨ã€‚

```cs
Type t = typeof(MyClass);
MethodInfo m = t.GetMethod("MyMethod");
object result = m.Invoke(myObject, new object[] { "arg1" });
```

### 23.3 åå°„çš„æ€§èƒ½
åå°„ä¸¤ä¸ªç¼ºç‚¹ï¼š
- åå°„é€ æˆç¼–è¯‘æ—¶æ— æ³•ä¿è¯ç±»å‹å®‰å…¨æ€§ã€‚ç”±äºåå°„ä¸¥é‡ä¾èµ–å­—ç¬¦ä¸²ï¼Œæ‰€ä»¥ä¼šä¸§å¤±ç¼–è¯‘æ—¶çš„ç±»å‹å®‰å…¨æ€§
- åå°„é€Ÿåº¦æ…¢ã€‚ä½¿ç”¨åå°„æ—¶ï¼Œç±»å‹åŠå…¶æˆå‘˜çš„åç§°åœ¨ç¼–è¯‘æ—¶æœªçŸ¥ï¼›ä½ è¦ç”¨å­—ç¬¦ä¸²åç§°æ ‡è¯†æ¯ä¸ªç±»å‹åŠå…¶æˆå‘˜ï¼Œç„¶ååœ¨è¿è¡Œæ—¶å‘ç°å®ƒä»¬ã€‚è€Œä¸”é€šå¸¸å­—ç¬¦ä¸²æœç´¢æ‰§è¡Œçš„æ˜¯ä¸åŒºåˆ†å¤§å°å†™çš„æ¯”è¾ƒï¼Œè¿™ä¼šè¿›ä¸€æ­¥å½±å“é€Ÿåº¦ã€‚

ä½¿ç”¨åå°„è°ƒç”¨æˆå‘˜ä¹Ÿä¼šå½±å“æ€§èƒ½ã€‚æœ€å¥½é¿å…åˆ©ç”¨åå°„æ¥è®¿é—®å­—æ®µæˆ–è°ƒç”¨æ–¹æ³•/å±æ€§ã€‚åº”è¯¥åˆ©ç”¨ä»¥ä¸‹ä¸¤ç§æŠ€æœ¯ä¹‹ä¸€å¼€å‘åº”ç”¨ç¨‹åºæ¥åŠ¨æ€å‘ç°å’Œæ„é€ ç±»å‹å®ä¾‹ï¼š
- è®©ç±»å‹ä»ç¼–è¯‘æ—¶å·²çŸ¥çš„åŸºç±»å‹æ´¾ç”Ÿ
- è®©ç±»å‹å®ç°ç¼–è¯‘æ—¶å·²çŸ¥çš„æ¥å£

ä½¿ç”¨åŸºç±»:
```cs
// æŠ½è±¡åŸºç±»å®šä¹‰â€œå¥‘çº¦â€
public abstract class Animal
{
    public abstract void Speak();
}

// æ´¾ç”Ÿç±»å®ç°
public class Dog : Animal
{
    public override void Speak()
    {
        Console.WriteLine("Woof!");
    }
}

public class Cat : Animal
{
    public override void Speak()
    {
        Console.WriteLine("Meow!");
    }
}
```

```cs
public static void Main()
{
    string typeName = "Dog"; // å‡è®¾æ˜¯åŠ¨æ€ä¼ å…¥çš„ç±»å‹å

    // ä½¿ç”¨ Activator åˆ›å»ºå®ä¾‹ï¼ˆä»éœ€åå°„åŠ è½½ç±»ï¼Œä½†ä¸è°ƒç”¨åå°„æ–¹æ³•ï¼‰
    Animal animal = (Animal)Activator.CreateInstance(Type.GetType(typeName)!);
    
    animal.Speak(); // ç±»å‹å®‰å…¨ã€æ— åå°„è°ƒç”¨
}
```

ä½¿ç”¨æ¥å£:
```cs
public interface IPlugin
{
    void Execute();
}

public class MyPlugin : IPlugin
{
    public void Execute()
    {
        Console.WriteLine("Plugin executed!");
    }
}
```

```cs
public static void Main()
{
    string typeName = "MyPlugin";

    // å‡è®¾ç±»å‹å·²åŠ è½½ï¼ˆé€šå¸¸é€šè¿‡ Assembly.Load...ï¼‰
    Type pluginType = Type.GetType(typeName)!;

    // å®ä¾‹åŒ–å¹¶è½¬å‹ä¸ºæ¥å£ï¼ˆä»ä½¿ç”¨åå°„åˆ›å»ºå¯¹è±¡ï¼Œä½†è°ƒç”¨æ˜¯ç±»å‹å®‰å…¨çš„ï¼‰
    IPlugin plugin = (IPlugin)Activator.CreateInstance(pluginType)!;

    plugin.Execute(); // ç±»å‹å®‰å…¨
}
```

ç›´æ¥åå°„ï¼š
```cs
// åå°„æ–¹å¼ï¼ˆä¸æ¨èï¼‰
object obj = Activator.CreateInstance(Type.GetType("MyPlugin")!);
obj.GetType().GetMethod("Execute")!.Invoke(obj, null); // æ€§èƒ½å·® + æ˜“é”™
```

é¢å‘æ¥å£æˆ–åŸºç±»çš„è°ƒç”¨æ˜¯â€œç¼–è¯‘æ—¶ç»‘å®š + JIT ä¼˜åŒ–â€ï¼Œè€Œåå°„æ˜¯â€œè¿è¡Œæ—¶æŸ¥æ‰¾ + æ— ä¼˜åŒ– + æ— ç±»å‹å®‰å…¨â€ã€‚

#### 23.3.1 å‘ç°ç¨‹åºé›†ä¸­å®šä¹‰çš„ç±»å‹
Assembly.ExportedTypesï¼šè¡¨ç¤ºå½“å‰ç¨‹åºé›†ä¸­â€œå…¬å¼€ï¼ˆpublicï¼‰å¯¼å‡ºâ€çš„æ‰€æœ‰ç±»å‹

```cs
public class Program
{
    public static void Main()
    {
        Assembly asm = Assembly.Load("MyLibrary");

        Console.WriteLine("Exported types:");
        foreach (Type t in asm.ExportedTypes)
        {
            Console.WriteLine(t.FullName);
        }
    }
}
```

#### 23.3.2 ç±»å‹å¯¹è±¡çš„å‡†ç¡®å«ä¹‰
ä¸Šé¢éå†çš„ asm.ExportedTypes æ˜¯ä¸€ä¸ª IEnumerable\<Type\>ï¼Œä¹Ÿå°±æ˜¯ç”±å¤šä¸ª System.Type å¯¹è±¡ç»„æˆçš„é›†åˆã€‚

Ststem.Typeå¯¹è±¡ä»£è¡¨ä¸€ä¸ªç±»å‹çš„å¼•ç”¨ï¼ˆè€Œä¸æ˜¯ç±»å‹çš„å®šä¹‰ï¼‰ã€‚ç”±äºåœ¨ä¸€ä¸ªAppDomainä¸­ï¼Œæ¯ä¸ªç±»å‹åªæœ‰ä¸€ä¸ªTypeå¯¹è±¡ï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨ç›¸ç­‰å’Œä¸ç­‰æ“ä½œç¬¦åˆ¤æ–­ä¸¤ä¸ªå¯¹è±¡æ˜¯ä¸æ˜¯ç›¸åŒç±»å‹ã€‚

```cs
Type t1 = typeof(string);
Type t2 = "hello".GetType();

Console.WriteLine(t1 == t2); // True
```

Type å¯¹è±¡æ˜¯è½»é‡çº§çš„å¯¹è±¡å¼•ç”¨ã€‚è¦æ›´å¤šåœ°äº†è§£ç±»å‹æœ¬èº«ï¼Œå¿…é¡»è·å–ä¸€ä¸ª TypeInfo å¯¹è±¡ï¼Œåè€…æ‰ä»£è¡¨ç±»å‹å®šä¹‰ã€‚
```cs
Type typeReference = ...;       // ä¾‹å¦‚ï¼š o.GetType() æˆ–è€… typeof(Object)
TypeInfo typeDefinition = typeReference.GetTypeInfo();
```

è¿˜å¯è°ƒç”¨ TypeInfo çš„ AsType æ–¹æ³•å°† TypeInfo å¯¹è±¡è½¬æ¢æˆ Type å¯¹è±¡ã€‚

```cs
TypeInfo typeDefinition = ...;
Type typeReference = typeDefinition.AsType();
```


#### 23.3.4 æ„é€ ç±»å‹çš„å®ä¾‹

è·å¾—å¯¹ Type æ´¾ç”Ÿå¯¹è±¡çš„å¼•ç”¨ä¹‹åï¼Œå°±å¯ä»¥æ„é€ è¯¥ç±»å‹çš„å®ä¾‹äº†ã€‚FCL æä¾›äº†ä»¥ä¸‹å‡ ä¸ªæœºåˆ¶:
- System.Activator çš„ CreateInstance æ–¹æ³•
- System.Activator çš„ CreateInstanceFrom æ–¹æ³•
- System.AppDomain çš„æ–¹æ³•
- System.Reflection.ConstructorInfo çš„ Invoke å®ä¾‹æ–¹æ³•

| æ–¹æ³•                             | ç±»å‹æ¥æº                          | æ˜¯å¦éœ€è¦æ„é€ å‡½æ•°ä¿¡æ¯    | æ˜¯å¦æ”¯æŒè·¨ç¨‹åºé›†  | æ€§èƒ½            | å¤‡æ³¨             |
| ------------------------------ | ----------------------------- | ------------- | --------- | ------------- | -------------- |
| `Activator.CreateInstance`     | `Type`                        | âŒ ä¸éœ€è¦æ‰‹åŠ¨æŒ‡å®šæ„é€ å‡½æ•° | âœ… æ˜¯       | ğŸš€ å¿«          | å¸¸ç”¨ï¼Œé€‚åˆé»˜è®¤æ„é€       |
| `Activator.CreateInstanceFrom` | `assembly path` + `type name` | âŒ ä¸éœ€è¦         | âœ… æ˜¯       | ğŸ¢ æ…¢          | ç”¨äºè·¨ç¨‹åºé›†ã€æœªåŠ è½½çš„ç±»å‹  |
| `AppDomain.CreateInstance*`    | `assembly name` + `type name` | âŒ ä¸éœ€è¦         | âœ… æ˜¯ï¼ˆå¦ä¸€ä¸ªåŸŸï¼‰ | ğŸ¢ æ…¢          | .NET Core ä¸­å·²æ·˜æ±° |
| `ConstructorInfo.Invoke`       | `ConstructorInfo`             | âœ… éœ€è¦          | âœ… æ˜¯       | ğŸš€ å¿«ï¼ˆç•¥æ…¢äº newï¼‰ | æœ€çµæ´»ï¼Œå¯è°ƒç”¨ä»»æ„æ„é€ å‡½æ•°  |


```cs
internal sealed class Dictionary<Tkey, TValue> { }

public static class Program {
    public static void Main() {
        // è·å–å¯¹æ³›å‹ç±»å‹çš„ç±»å‹å¯¹è±¡çš„å¼•ç”¨
        Type openType = typeof(Dictionary<,>);

        // ä½¿ç”¨ TKey=Stringã€TValue=Int32 å°é—­æ³›å‹ç±»å‹ â‘ 
        Type closedType = openType.MakeGenericType(typeof(String), typeof(Int32));

        // æ„é€ å°é—­ç±»å‹çš„å®ä¾‹
        Object o = Activator.CreateInstance(closedType);

        // è¯å®èƒ½æ­£å¸¸å·¥ä½œ
        Console.WriteLine(o.GetType());
    }
}
```

`Object o = Activator.CreateInstance(closedType);` åŠŸèƒ½ä¸Šç­‰ä»·äºï¼š`var o = new Dictionary<string, int>();`

- Activator.CreateInstance(closedType) å’Œ new çš„æ•ˆæœä¸€æ ·ï¼ˆè°ƒç”¨æ— å‚æ„é€ å‡½æ•°ï¼‰ï¼›
- ä½†åå°„æ–¹å¼æ˜¯ è¿è¡Œæ—¶åŠ¨æ€æ„é€ ï¼Œç”¨äºç±»å‹ä¸ç¡®å®šçš„æƒ…å†µï¼›
- å¦‚æœçŸ¥é“ç±»å‹ï¼Œç”¨ new æ›´å¿«æ›´å®‰å…¨ï¼›
- å¦‚æœè¦æ”¯æŒæ’ä»¶ã€æ³›å‹ã€é…ç½®é©±åŠ¨ç±»å‹ï¼Œé‚£ MakeGenericType + CreateInstance éå¸¸æœ‰ç”¨ã€‚

### 23.5 ä½¿ç”¨åå°„å‘ç°ç±»å‹çš„æˆå‘˜
#### 23.5.1 å‘ç°ç±»å‹çš„æˆå‘˜
å­—æ®µã€æ„é€ å™¨ã€æ–¹æ³•ã€å±æ€§ã€äº‹ä»¶å’ŒåµŒå¥—ç±»å‹éƒ½å¯ä»¥å®šä¹‰æˆç±»å‹çš„æˆå‘˜ã€‚FCL åŒ…å«æŠ½è±¡åŸºç±» System.Reflection.MemberInfo ï¼Œå°è£…äº†æ‰€æœ‰ç±»å‹æˆå‘˜éƒ½é€šç”¨çš„ä¸€ç»„å±æ€§ã€‚MemberInfo æœ‰è®¸å¤šæ´¾ç”Ÿç±»ï¼Œæ¯ä¸ªéƒ½å°è£…äº†ä¸ç‰¹å®šç±»å‹æˆå‘˜ç›¸å…³çš„æ›´å¤šå±æ€§ã€‚

![2025-08-03-14-04-06.png](./images/2025-08-03-14-04-06.png)

![2025-08-03-14-10-22.png](./images/2025-08-03-14-10-22.png)


åŸºäº AppDomainï¼Œå¯å‘ç°å…¶ä¸­åŠ è½½çš„æ‰€æœ‰ç¨‹åºé›†ã€‚åŸºäºç¨‹åºé›†ï¼Œå¯å‘ç°æ„æˆå®ƒçš„æ‰€æœ‰æ¨¡å—ã€‚åŸºäºç¨‹åºé›†æˆ–æ¨¡å—ï¼Œå¯å‘ç°å®ƒå®šä¹‰çš„æ‰€æœ‰ç±»å‹ã€‚åŸºäºç±»å‹ï¼Œå¯å‘ç°å®ƒçš„åµŒå¥—ç±»å‹ã€å­—æ®µã€æ„é€ å™¨ã€æ–¹æ³•ã€å±æ€§å’Œäº‹ä»¶ã€‚å‘½åç©ºé—´ä¸æ˜¯è¿™ä¸ªå±‚æ¬¡ç»“æ„çš„ä¸€éƒ¨åˆ†ï¼Œå› ä¸ºå®ƒä»¬åªæ˜¯ä»è¯­æ³•è§’åº¦å°†ç›¸å…³ç±»å‹èšé›†åˆ°ä¸€èµ·ã€‚CLR ä¸çŸ¥é“ä»€ä¹ˆæ˜¯å‘½åç©ºé—´ã€‚è¦åˆ—å‡ºç¨‹åºé›†ä¸­å®šä¹‰çš„æ‰€æœ‰å‘½åç©ºé—´ï¼Œéœ€æšä¸¾ç¨‹åºé›†ä¸­çš„æ‰€æœ‰ç±»å‹ï¼Œå¹¶æŸ¥çœ‹å…¶ Namespace å±æ€§ã€‚

![2025-08-03-14-16-46.png](./images/2025-08-03-14-16-46.png)


åŸºäºç±»å‹å‘ç°å®ƒå®ç°çš„æ¥å£ï¼š
```cs
Type type = typeof(MyClass);
Type[] interfaces = type.GetInterfaces();
```
ä»æ„é€ å™¨ã€æ–¹æ³•ã€å±æ€§è®¿é—®å™¨ã€äº‹ä»¶æ·»åŠ /åˆ é™¤æ–¹æ³•è·å–å‚æ•°ä¿¡æ¯:
```cs
MethodInfo method = type.GetMethod("MyMethod");
ParameterInfo[] parameters = method.GetParameters();
```
å¯¹å±æ€§çš„è®¿é—®å™¨ï¼ˆget_XXX æˆ– set_XXX æ–¹æ³•ï¼‰å’Œäº‹ä»¶çš„æ·»åŠ /åˆ é™¤æ–¹æ³•ï¼ˆadd_XXXã€remove_XXXï¼‰ä¹Ÿå¯ä»¥é€šè¿‡ç±»ä¼¼æ–¹å¼è·å–å‚æ•°ï¼š
```cs
PropertyInfo prop = type.GetProperty("MyProperty");
MethodInfo getter = prop.GetGetMethod();
ParameterInfo[] getterParams = getter.GetParameters();
```
æŸ¥è¯¢åªè¯»å±æ€§ ReturnParameter è·å¾—è¿”å›å‚æ•°ä¿¡æ¯:
```cs
ParameterInfo returnParam = method.ReturnParameter;
Type returnType = returnParam.ParameterType;
```
å¯¹äºæ³›å‹ç±»å‹æˆ–æ–¹æ³•ï¼Œå¯è°ƒç”¨ GetGenericArguments è·å–ç±»å‹å‚æ•°é›†åˆ:
```cs
Type genericType = typeof(List<>);
Type[] typeArgs = genericType.GetGenericArguments();

MethodInfo genericMethod = typeof(MyClass).GetMethod("GenericMethod");
Type[] methodTypeArgs = genericMethod.GetGenericArguments();
```
æŸ¥è¯¢ CustomAttributes è·å–è‡ªå®šä¹‰ç‰¹æ€§é›†åˆ:
æ‰€æœ‰çš„ MemberInfo æ´¾ç”Ÿç±»å‹ï¼ˆåŒ…æ‹¬ Typeã€MethodInfoã€PropertyInfo ç­‰ï¼‰éƒ½æä¾› CustomAttributes å±æ€§ï¼Œè¿”å›è‡ªå®šä¹‰ç‰¹æ€§çš„é›†åˆï¼š
```cs
foreach (var attrData in method.CustomAttributes)
{
    Console.WriteLine(attrData.AttributeType.Name);
}
```

#### 23.5.2 è°ƒç”¨ç±»å‹çš„æˆå‘˜
| æˆå‘˜ç±»å‹                | è°ƒç”¨æˆå‘˜çš„æ–¹æ³•                                                                                              | ä½œç”¨è¯´æ˜                  |
| ------------------- | ---------------------------------------------------------------------------------------------------- | --------------------- |
| **FieldInfo**       | `GetValue(object obj)` å’Œ `SetValue(object obj, object value)`                                        | è·å–å’Œè®¾ç½®å­—æ®µçš„å€¼             |
| **ConstructorInfo** | `Invoke(object[] parameters)`                                                                        | é€šè¿‡æ„é€ å‡½æ•°åˆ›å»ºå¯¹è±¡å®ä¾‹          |
| **MethodInfo**      | `Invoke(object obj, object[] parameters)`                                                            | è°ƒç”¨æ–¹æ³•                  |
| **PropertyInfo**    | `GetValue(object obj)` å’Œ `SetValue(object obj, object value)`                                        | è°ƒç”¨å±æ€§çš„ getter å’Œ setter |
| **EventInfo**       | `AddEventHandler(object obj, Delegate handler)` å’Œ `RemoveEventHandler(object obj, Delegate handler)` | æ·»åŠ æˆ–ç§»é™¤äº‹ä»¶å¤„ç†ç¨‹åº           |

```cs
void Main()
{
  Type type = typeof(MyClass);

        // 1. ä½¿ç”¨ ConstructorInfo.Invoke åˆ›å»ºå¯¹è±¡å®ä¾‹
        ConstructorInfo ctor = type.GetConstructor(Type.EmptyTypes);
        var instance = ctor.Invoke(null);
        Console.WriteLine("å¯¹è±¡å®ä¾‹åˆ›å»ºæˆåŠŸ");

        // 2. è®¿é—®å’Œä¿®æ”¹å­—æ®µ
        FieldInfo field = type.GetField("NumberField");
        Console.WriteLine("åˆå§‹å­—æ®µå€¼: " + field.GetValue(instance));
        field.SetValue(instance, 42);
        Console.WriteLine("ä¿®æ”¹åçš„å­—æ®µå€¼: " + field.GetValue(instance));

        // 3. è®¿é—®å’Œä¿®æ”¹å±æ€§
        PropertyInfo prop = type.GetProperty("Name");
        Console.WriteLine("åˆå§‹å±æ€§å€¼: " + prop.GetValue(instance));
        prop.SetValue(instance, "ReflectionUser");
        Console.WriteLine("ä¿®æ”¹åçš„å±æ€§å€¼: " + prop.GetValue(instance));

        // 4. è°ƒç”¨æ–¹æ³•
        MethodInfo method = type.GetMethod("SayHello");
        method.Invoke(instance, new object[] { "World" });

        // 5. äº‹ä»¶è®¢é˜…å’Œè§¦å‘
        EventInfo evt = type.GetEvent("SomethingHappened");
        EventHandler handler = (sender, e) => Console.WriteLine("äº‹ä»¶è¢«è§¦å‘äº†ï¼");
        evt.AddEventHandler(instance, handler);

        // è§¦å‘äº‹ä»¶
        MethodInfo raiseMethod = type.GetMethod("RaiseEvent");
        raiseMethod.Invoke(instance, null);

        // å–æ¶ˆäº‹ä»¶è®¢é˜…
        evt.RemoveEventHandler(instance, handler);

        // å†æ¬¡è§¦å‘äº‹ä»¶ä¸ä¼šè¾“å‡ºä»»ä½•ä¸œè¥¿
        raiseMethod.Invoke(instance, null);
}

public class MyClass
{
    public int NumberField;

    private string _name;

    public string Name
    {
        get => _name;
        set => _name = value;
    }

    public event EventHandler SomethingHappened;

    public MyClass()
    {
        NumberField = 10;
        _name = "InitialName";
    }

    public void SayHello(string message)
    {
        Console.WriteLine($"Hello, {message}! My name is {_name}.");
    }

    public void RaiseEvent()
    {
        SomethingHappened?.Invoke(this, EventArgs.Empty);
    }
}
```
![2025-08-03-14-51-58.png](./images/2025-08-03-14-51-58.png)

PropertyInfoç±»å‹ä»£è¡¨ä¸å±æ€§æœ‰å…³çš„å…ƒæ•°æ®ä¿¡æ¯ã€‚
EventInfoç±»å‹ä»£è¡¨ä¸äº‹ä»¶æœ‰å…³çš„å…ƒæ•°æ®ä¿¡æ¯ã€‚

#### 23.5.3 ä½¿ç”¨ç»‘å®šå¥æŸ„å‡å°‘è¿›ç¨‹çš„å†…å­˜æ¶ˆè€—
è®¸å¤šåº”ç”¨ç¨‹åºéƒ½ç»‘å®šäº†ä¸€ç»„ç±»å‹(Type å¯¹è±¡)æˆ–ç±»å‹æˆå‘˜(MemeberInfo æ´¾ç”Ÿå¯¹è±¡)ï¼Œå¹¶å°†è¿™äº›å¯¹è±¡ä¿å­˜åœ¨æŸç§å½¢å¼çš„é›†åˆä¸­ã€‚ä»¥åï¼Œåº”ç”¨ç¨‹åºæœç´¢è¿™ä¸ªé›†åˆï¼ŒæŸ¥æ‰¾ç‰¹å®šå¯¹è±¡ï¼Œç„¶åè°ƒç”¨(invoke)è¿™ä¸ªå¯¹è±¡ã€‚è¿™ä¸ªæœºåˆ¶å¾ˆå¥½ï¼Œåªæ˜¯æœ‰ä¸ªå°é—®é¢˜ï¼šType å’Œ MemberInfo æ´¾ç”Ÿå¯¹è±¡éœ€è¦å¤§é‡å†…å­˜ã€‚

CLR å†…éƒ¨ç”¨æ›´ç²¾ç®€çš„æ–¹å¼è¡¨ç¤ºè¿™ç§ä¿¡æ¯ã€‚CLR ä¹‹æ‰€ä»¥ä¸ºåº”ç”¨ç¨‹åºåˆ›å»ºè¿™äº›å¯¹è±¡ï¼Œåªæ˜¯ä¸ºäº†æ–¹ä¾¿å¼€å‘äººå‘˜ã€‚CLR ä¸éœ€è¦è¿™äº›å¤§å¯¹è±¡å°±èƒ½è¿è¡Œã€‚

å¦‚æœéœ€è¦ä¿å­˜/ç¼“å­˜å¤§é‡ Type å’Œ MemberInfo æ´¾ç”Ÿå¯¹è±¡ï¼Œå¼€å‘äººå‘˜å¯ä»¥ä½¿ç”¨è¿è¡Œæ—¶å¥æŸ„(runtime handle)ä»£æ›¿å¯¹è±¡ä»¥å‡å°å·¥ä½œé›†(å ç”¨çš„å†…å­˜)ã€‚

FCL å®šä¹‰äº†ä¸‰ä¸ªè¿è¡Œæ—¶å¥æŸ„:
- RuntimeTypeHandle
- RuntimeFieldHandle 
- RuntimeMethodHandle

ä¸‰ä¸ªç±»å‹éƒ½æ˜¯å€¼ç±»å‹ï¼Œéƒ½åªåŒ…å«ä¸€ä¸ªå­—æ®µï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ª IntPtr.

æ­£å¸¸ä½¿ç”¨ï¼š
```cs
// è¿™æ®µä»£ç å°±ç”¨ä¸€æ¬¡ Typeï¼Œä¸å å¤ªå¤šå†…å­˜ï¼Œå®Œå…¨æ²¡é—®é¢˜ã€‚
var type = typeof(MyClass);  // OKï¼Œè¿™ä¸ä¼šå‡ºå¤§é—®é¢˜
Console.WriteLine(type.Name);
```

é—®é¢˜åœºæ™¯ï¼šå¤§é‡ç¼“å­˜

```cs
List<Type> cachedTypes = new List<Type>();

foreach (var asm in AppDomain.CurrentDomain.GetAssemblies())
{
    foreach (var type in asm.GetTypes())
    {
        cachedTypes.Add(type); // å¤§é‡ Type å¯¹è±¡è¢«ç¼“å­˜
    }
}
```

æ›´å¥½çš„åšæ³•ï¼ˆä½¿ç”¨å¥æŸ„ï¼‰ï¼š

```cs
List<RuntimeTypeHandle> cachedHandles = new List<RuntimeTypeHandle>();

foreach (var type in someTypes)
{
    cachedHandles.Add(Type.GetTypeHandle(type));  // åªä¿å­˜å¥æŸ„ï¼Œå ç”¨å†…å­˜å°
}

// éœ€è¦æ—¶å†è¿˜åŸ
Type restored = Type.GetTypeFromHandle(cachedHandles[0]);
```

| æ“ä½œ                                 | æ–¹æ³•æˆ–å±æ€§                              |
| ---------------------------------- | ---------------------------------- |
| `Type â†’ RuntimeTypeHandle`         | `Type.GetTypeHandle(type)`         |
| `RuntimeTypeHandle â†’ Type`         | `Type.GetTypeFromHandle(handle)`   |
| `FieldInfo â†’ RuntimeFieldHandle`   | `field.FieldHandle`                |
| `RuntimeFieldHandle â†’ FieldInfo`   | `FieldInfo.GetFieldFromHandle()`   |
| `MethodInfo â†’ RuntimeMethodHandle` | `method.MethodHandle`              |
| `RuntimeMethodHandle â†’ MethodInfo` | `MethodInfo.GetMethodFromHandle()` |

## 24 è¿è¡Œæ—¶åºåˆ—åŒ–
åºåˆ—åŒ–æ˜¯å°†å¯¹è±¡æˆ–å¯¹è±¡å›¾è½¬æ¢æˆå­—èŠ‚æµçš„è¿‡ç¨‹ã€‚ååºåˆ—åŒ–æ˜¯å°†å­—èŠ‚æµè½¬æ¢å›å¯¹è±¡å›¾çš„è¿‡ç¨‹ã€‚

ä¸€æ—¦å°†å¯¹è±¡åºåˆ—åŒ–æˆå†…å­˜ä¸­çš„å­—èŠ‚æµï¼Œå°±å¯æ–¹ä¾¿åœ°ä»¥ä¸€äº›æ›´æœ‰ç”¨çš„æ–¹å¼å¤„ç†æ•°æ®ï¼Œæ¯”å¦‚è¿›è¡ŒåŠ å¯†å’Œå‹ç¼©ã€‚

### 24.1 åºåˆ—åŒ–å’Œååºåˆ—åŒ–å¿«é€Ÿå…¥é—¨
![2025-08-03-20-23-06.png](./images/2025-08-03-20-23-06.png)

å¯ä»¥å°†å¤šä¸ªå¯¹è±¡å›¾åºåˆ—åŒ–åˆ°ä¸€ä¸ªæµä¸­ï¼š
```cs
private static void SaveApplicationState(Stream stream) {
    // æ„é€ åºåˆ—åŒ–æ ¼å¼åŒ–å™¨æ¥æ‰§è¡Œæ‰€æœ‰å®é™…çš„å·¥ä½œ
    BinaryFormatter formatter = new BinaryFormatter();

    // åºåˆ—åŒ–æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºçš„å®Œæ•´çŠ¶æ€
    formatter.Serialize(stream, s_customers);
    formatter.Serialize(stream, s_pendingOrders);
    formatter.Serialize(stream, s_processedOrders);
}

private static void RestoreApplicationState(Stream stream) {
    // æ„é€ åºåˆ—åŒ–æ ¼å¼åŒ–å™¨æ¥æ‰§è¡Œæ‰€æœ‰å®é™…çš„å·¥ä½œ
    BinaryFormatter formatter = new BinaryFormatter();

    // ååºåˆ—åŒ–åº”ç”¨ç¨‹åºçš„å®Œæ•´çŠ¶æ€(å’Œåºåˆ—åŒ–æ—¶çš„é¡ºåºä¸€æ ·)
    s_customers = (List<Customer>)    formatter.Deserialize(stream);
    s_pendingOrders = (List<Order>)   formatter.Deserialize(stream);
    s_processedOrders = (List<Order>) formatter.Deserialize(stream);
}
```

åºåˆ—åŒ–å¯¹è±¡æ—¶ï¼Œç±»å‹çš„å…¨åå’Œç±»å‹å®šä¹‰ç¨‹åºé›†çš„å…¨åä¼šè¢«å†™å…¥æµã€‚

### 24.2 ä½¿ç±»å‹å¯åºåˆ—åŒ–
è®¾è®¡ç±»å‹æ—¶ï¼Œè®¾è®¡äººå‘˜å¿…é¡»çé‡åœ°å†³å®šæ˜¯å¦å…è®¸ç±»å‹çš„å®ä¾‹åºåˆ—åŒ–ã€‚ç±»å‹é»˜è®¤æ˜¯ä¸å¯åºåˆ—åŒ–å¯¹çš„ã€‚

![2025-08-03-21-17-29.png](./images/2025-08-03-21-17-29.png)

åƒä¸‹é¢è¿™æ ·å‘ç±»å‹åº”ç”¨å®šåˆ¶ç‰¹æ€§ System.SerializableAttributeæ‰ä¸ä¼šæŠ›å‡ºé”™è¯¯ã€‚
```cs
[Serializable]
internal struct Point { public Int32 x, y; }
```

### 24.3 æ§åˆ¶åºåˆ—åŒ–å’Œååºåˆ—åŒ–
å°† SerializableAttribute å®šåˆ¶ç‰¹æ€§åº”ç”¨äºç±»å‹ï¼Œæ‰€æœ‰å®ä¾‹å­—æ®µ(publicï¼Œprivate å’Œ protectedç­‰)éƒ½ä¼šè¢«åºåˆ—åŒ–ã€‚

ä½¿ç”¨ System.NonSerializedAttribute å®šåˆ¶ç‰¹æ€§æŒ‡å‡ºç±»å‹ä¸­ä¸åº”åºåˆ—åŒ–çš„å­—æ®µå¯é™åˆ¶å“ªäº›ä¸å¯åºåˆ—åŒ–ã€‚

```cs
[Serializable]
internal class Circle {
    private Double m_radius;

    [NonSerialized]
    private Double m_area;  

    public Circle(Double radius) {
        m_radius = radius;
        m_area = Math.PI * m_radius * m_radius;
    }

    ...
}
```

è¿™ä¸ªå¯¹è±¡åºåˆ—åŒ–æ—¶ï¼Œåªæœ‰ m_radius å­—æ®µçš„å€¼(10) æ‰ä¼šå†™å…¥æµï¼Œä½†å½“æµååºåˆ—åŒ–æˆ Circle å¯¹è±¡çš„ m_radius å­—æ®µä¼šè¢«è®¾ä¸º 10ï¼Œä½†å®ƒçš„ m_area å­—æ®µä¼šè¢«åˆå§‹åŒ–æˆ 0 .

```cs
[Serializable]
internal class Circle {
    private Double m_radius;            // åŠå¾„

    [NonSerialized]
    private Double m_area;              // é¢ç§¯

    public Circle(Double radius) {
        m_radius = radius;
        m_area = Math.PI * m_radius * m_radius;
    }

    [OnDeserialized]
    private void OnDeserialized(StreamingContext context) {
        m_area = Math.PI * m_radius * m_radius;
    }
}
```

Circle ç±»åŒ…å«ä¸€ä¸ªæ ‡è®°äº† System.Runtime.Serialization.OnDeserializedAttribute å®šåˆ¶ç‰¹æ€§çš„æ–¹æ³•ã€‚æ¯æ¬¡ååºåˆ—åŒ–ç±»å‹çš„å®ä¾‹ï¼Œæ ¼å¼åŒ–å™¨éƒ½ä¼šæ£€æŸ¥ç±»å‹ä¸­æ˜¯å¦å®šä¹‰äº†åº”ç”¨äº†è¯¥ç‰¹æ€§çš„æ–¹æ³•ã€‚å¦‚æœæ˜¯ï¼Œå°±è°ƒç”¨è¯¥æ–¹æ³•ã€‚(å°±æ˜¯è¯´æ¯æ¬¡ååºåˆ—åŒ–éƒ½ä¼šè°ƒç”¨OnDeserializedè¿™ä¸ªæ–¹æ³•)

é™¤äº† OnDeserializedAttribute è¿™ä¸ªå®šåˆ¶ç‰¹æ€§ï¼ŒSystem.Runtime.Serialization å‘½åç©ºé—´è¿˜å®šä¹‰äº†åŒ…æ‹¬ OnSerializingAttributeï¼ŒOnSerializedAttribute å’Œ OnDeserializingAttribute åœ¨å†…çš„å…¶ä»–å®šåˆ¶ç‰¹æ€§ã€‚

```cs
[OnDeserializing]
private void OnDeserializing(StreamingContext context) {
    // ä¸¾ä¾‹ï¼šåœ¨è¿™ä¸ªç±»å‹çš„æ–°ç‰ˆæœ¬ä¸­ï¼Œä¸ºå­—æ®µè®¾ç½®é»˜è®¤å€¼
}

[OnDeserialized]
private void OnDeserialized(StreamingContext context) {
    // ä¸¾ä¾‹ï¼šæ ¹æ®å­—æ®µå€¼åˆå§‹åŒ–ç¬æ—¶çŠ¶æ€(æ¯”å¦‚ sum çš„å€¼)
    sum = x + y;
}

[OnSerializing]
private void OnSerializing(StreamingContext context) {
    // ä¸¾ä¾‹ï¼šåœ¨åºåˆ—åŒ–å‰ï¼Œä¿®æ”¹ä»»ä½•éœ€è¦ä¿®æ”¹çš„çŠ¶æ€
}

[OnSerialized]
private void OnSerialized(StreamingContext context) {
    // ä¸¾ä¾‹ï¼šåœ¨åºåˆ—åŒ–åï¼Œæ¢å¤ä»»ä½•éœ€è¦æ¢å¤çš„çŠ¶æ€
}
```

å¦‚æœåºåˆ—åŒ–ç±»å‹çš„å®ä¾‹ï¼Œåœ¨ç±»å‹ä¸­æ·»åŠ æ–°å­—æ®µï¼Œç„¶åè¯•å›¾ååºåˆ—åŒ–ä¸åŒ…å«æ–°å­—æ®µçš„å¯¹è±¡ï¼Œæ ¼å¼åŒ–å™¨ä¼šæŠ›å‡º SerializationException å¼‚å¸¸ã€‚

### 24.4 æ ¼å¼åŒ–å™¨å¦‚ä½•åºåˆ—åŒ–ç±»å‹å®ä¾‹
FCL åœ¨ System.Runtime.Serialization å‘½åç©ºé—´æä¾›äº†ä¸€ä¸ª FormatterServices ç±»å‹ã€‚è¯¥ç±»å‹åªåŒ…å«é™æ€æ–¹æ³•ï¼Œè€Œä¸”è¯¥ç±»å‹ä¸èƒ½å®ä¾‹åŒ–ã€‚

æ ¼å¼åŒ–å™¨é  FormatterServices è·å–å“ªäº›å­—æ®µè¦åºåˆ—åŒ–ï¼Œå†é€šè¿‡åå°„è¯»å–è¿™äº›å­—æ®µçš„å€¼ï¼Œå†æŠŠç±»å‹å+å­—æ®µ+å€¼å†™å…¥æµä¸­ï¼Œå®Œæˆåºåˆ—åŒ–ï¼š
- è·å–å¯åºåˆ—åŒ–å­—æ®µåˆ—è¡¨
    - è°ƒç”¨ FormatterServices çš„ GetSerializableMembers æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•åˆ©ç”¨åå°„è·å–ç±»å‹çš„ public å’Œ private å®ä¾‹å­—æ®µ
    - æ–¹æ³•è¿”å›ç”± MemberInfo å¯¹è±¡æ„æˆçš„æ•°ç»„ï¼Œå…¶ä¸­æ¯ä¸ªå…ƒç´ éƒ½å¯¹åº”ä¸€ä¸ªå¯åºåˆ—åŒ–çš„å®ä¾‹å­—æ®µ
- è·å–å­—æ®µçš„å€¼
    - System.Reflection.MemberInfo å¯¹è±¡æ•°ç»„ä¼ ç»™ FormatterServices çš„é™æ€æ–¹æ³• GetObjectData
    - è¿”å›å¯¹åº”çš„å­—æ®µå€¼æ•°ç»„ object[]
    - ä¸Šä¸ªæ–¹æ³•å¾—åˆ°çš„MemberInfo[]å’Œè¿™ä¸ªæ–¹æ³•å¾—åˆ°çš„object[]ä¸¤ä¸ªæ•°ç»„æ˜¯â€œä¸€ä¸€å¯¹åº”â€çš„
    - ![2025-08-03-21-39-42.png](./images/2025-08-03-21-39-42.png)
- æŠŠç±»å‹ä¿¡æ¯å†™å…¥æµ
    - å°†ç¨‹åºé›†æ ‡è¯†å’Œç±»å‹çš„å®Œæ•´åç§°å†™å…¥æµä¸­
- å†™å…¥å­—æ®µæ•°æ®åˆ°æµ
    - æ ¼å¼åŒ–å™¨éå†ä¸¤ä¸ªæ•°ç»„ä¸­çš„å…ƒç´ ï¼Œå°†æ¯ä¸ªæˆå‘˜çš„åç§°å’Œå€¼å†™å…¥æµä¸­

CLR åœ¨ååºåˆ—åŒ–æ—¶ï¼Œé€šè¿‡ è·³è¿‡æ„é€ å‡½æ•° çš„æ–¹å¼ï¼Œåˆ†é…å¯¹è±¡å¹¶æ‰‹åŠ¨å¡«å……å­—æ®µå€¼ï¼Œæ•´ä¸ªè¿‡ç¨‹ç»•å¼€äº†æ­£å¸¸çš„å¯¹è±¡åˆå§‹åŒ–é€»è¾‘ï¼š
- ç¡®å®šååºåˆ—åŒ–çš„ç±»å‹
    - æ ¼å¼åŒ–å™¨ä»æµä¸­è¯»å–ç¨‹åºé›†æ ‡è¯†å’Œå®Œæ•´ç±»å‹åç§°ã€‚
    - å°†ç¨‹åºé›†æ ‡è¯†ä¿¡æ¯å’Œç±»å‹å…¨åä¼ ç»™ FormatterServices çš„é™æ€æ–¹æ³• GetTypeFromAssembly
    - è¿™ä¸ªæ–¹æ³•è¿”å›ä¸€ä¸ª System.Type å¯¹è±¡ï¼Œå®ƒä»£è¡¨è¦ååºåˆ—åŒ–çš„é‚£ä¸ªå¯¹è±¡çš„ç±»å‹
- åˆ›å»ºæœªåˆå§‹åŒ–çš„å¯¹è±¡ï¼ˆè·³è¿‡æ„é€ å‡½æ•°ï¼‰
    - æ ¼å¼åŒ–å™¨è°ƒç”¨ FormmatterServices çš„é™æ€æ–¹æ³• GetUninitializedObject
    - è¿™ä¸ªæ–¹æ³•ä¸ºä¸€ä¸ªæ–°å¯¹è±¡åˆ†é…å†…å­˜ï¼Œä½†ä¸ä¸ºå¯¹è±¡è°ƒç”¨æ„é€ å™¨
- æ‰¾å‡ºéœ€è¦å¡«å……çš„å­—æ®µ
    - - æ ¼å¼åŒ–å™¨ç°åœ¨æ„é€ å¹¶åˆå§‹åŒ–ä¸€ä¸ª MemberInfo æ•°ç»„ï¼Œå…·ä½“åšæ³•å’Œå‰é¢ä¸€æ ·ï¼Œéƒ½æ˜¯è°ƒç”¨ FormatterServices çš„ GetSerializableMembers æ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•è¿”å›åºåˆ—åŒ–å¥½ã€ç°åœ¨éœ€è¦ååºåˆ—åŒ–çš„ä¸€ç»„å­—æ®µã€‚
- è¯»å–å­—æ®µçš„å€¼
    - æ ¼å¼åŒ–å™¨æ ¹æ®æµä¸­åŒ…å«çš„æ•°æ®åˆ›å»ºå¹¶åˆå§‹åŒ–ä¸€ä¸ª Object æ•°ç»„
- æŠŠå­—æ®µå€¼â€œçŒå…¥â€åˆ°æ–°å¯¹è±¡ä¸­
    - å°†æ–°åˆ†é…å¯¹è±¡ã€MemberInfo æ•°ç»„ä»¥åŠå¹¶è¡Œ Object æ•°ç»„(å…¶ä¸­åŒ…å«å­—æ®µå€¼)çš„å¼•ç”¨ä¼ ç»™ FormatterServices çš„é™æ€æ–¹æ³• PopulateObjectMembers
    - è¿™ä¸ªæ–¹æ³•éå†æ•°ç»„ï¼Œå°†æ¯ä¸ªå­—æ®µåˆå§‹åŒ–æˆå¯¹åº”çš„å€¼

### 24.5 æ§åˆ¶åºåˆ—åŒ–/ååºåˆ—åŒ–çš„æ•°æ®
æ§åˆ¶åºåˆ—åŒ–å’Œååºåˆ—åŒ–è¿‡ç¨‹çš„æœ€ä½³æ–¹å¼å°±æ˜¯ä½¿ç”¨ OnSerializingï¼ŒOnSerializedï¼ŒOnDeserializingï¼ŒOnDeserializedï¼ŒNonSerialized å’Œ OptionalField ç­‰ç‰¹æ€§ã€‚

ç„¶è€Œï¼Œåœ¨ä¸€äº›æå°‘è§çš„æƒ…å†µä¸‹ï¼Œè¿™äº›ç‰¹æ€§ä¸èƒ½æä¾›æƒ³è¦çš„å…¨éƒ¨æ§åˆ¶ã€‚æ­¤å¤–ï¼Œæ ¼å¼åŒ–å™¨å†…éƒ¨ä½¿ç”¨çš„æ˜¯åå°„ï¼Œè€Œåå°„çš„é€Ÿåº¦æ¯”è¾ƒæ…¢ã€‚

ä¸ºäº†å¯¹åºåˆ—åŒ–/ååºåˆ—åŒ–çš„æ•°æ®è¿›è¡Œå®Œå…¨çš„æ§åˆ¶ï¼Œå¹¶é¿å…ä½¿ç”¨åå°„ï¼Œè‡ªå®šä¹‰ç±»å‹å¯å®ç°System.Runtime.Serialization.ISerializableæ¥å£ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š

```cs

public interface ISerializable {
    void GetObjectData(SerializationInfo info, StreamingContext context);
}
```

ISerializable æ¥å£å’Œç‰¹æ®Šæ„é€ å™¨æ—¨åœ¨ç”±æ ¼å¼åŒ–å™¨ä½¿ç”¨ã€‚ä½†å…¶ä»–ä»£ç å¯èƒ½è°ƒç”¨ GetObjectData æ¥è¿”å›æ•æ„Ÿæ•°æ®ã€‚å¦å¤–ï¼Œå…¶ä»–ä»£ç å¯èƒ½æ„é€ å¯¹è±¡ï¼Œå¹¶ä¼ å…¥æŸåçš„æ•°æ®ã€‚å› æ­¤ï¼Œå»ºè®®å‘ GetObjectData æ–¹æ³•å’Œç‰¹æ®Šæ„é€ å™¨åº”ç”¨ä»¥ä¸‹ç‰¹æ€§ï¼š

`[SecurityPermissionAttribute(SecurityAction.Demand, SerializationFormatter = true)]`

```cs
using System.Runtime.Serialization;
using System.Runtime.Serialization.Formatters.Binary;
void Main()
{
        Person person = new Person("Alice", 30);

        // åºåˆ—åŒ–
        // formatteræ˜¯æ ¼å¼åŒ–å™¨
        IFormatter formatter = new BinaryFormatter();
        using (FileStream stream = new FileStream("D:/Cedar/linqpad/person.bin", FileMode.Create, FileAccess.Write))
        {
            formatter.Serialize(stream, person);
        }

        // ååºåˆ—åŒ–
        using (FileStream stream = new FileStream("D:/Cedar/linqpad/person.bin", FileMode.Open, FileAccess.Read))
        {
            Person deserialized = (Person)formatter.Deserialize(stream);
            Console.WriteLine(deserialized);
        }
}

[Serializable]
public class Person : ISerializable
{
    public string Name;
    public int Age;

    public Person(string name, int age)
    {
        Name = name;
        Age = age;
    }

    // åºåˆ—åŒ–æ–¹æ³•
    public void GetObjectData(SerializationInfo info, StreamingContext context)
    {
        Console.WriteLine("Serializing...");
        info.AddValue("Name", Name);
        info.AddValue("Age", Age);
    }

    // ååºåˆ—åŒ–æ„é€ å‡½æ•°
    protected Person(SerializationInfo info, StreamingContext context)
    {
        Console.WriteLine("Deserializing...");
        Name = info.GetString("Name");
        Age = info.GetInt32("Age");
    }
}
```
![2025-08-05-21-00-43.png](./images/2025-08-05-21-00-43.png)

æ ¼å¼åŒ–å™¨åºåˆ—åŒ–å¯¹è±¡å›¾æ—¶ä¼šæ£€æŸ¥æ¯ä¸ªå¯¹è±¡ã€‚å¦‚æœå‘ç°ä¸€ä¸ªå¯¹è±¡çš„ç±»å‹å®ç°äº† ISerializable æ¥å£ï¼Œå°±ä¼šå¿½ç•¥æ‰€æœ‰å®šåˆ¶ç‰¹æ€§ï¼Œæ”¹ä¸ºæ„é€ æ–°çš„ System.Runtime.Serialization.SerializationInfo å¯¹è±¡ã€‚


æ‰§è¡Œ`formatter.Serialize(stream, person);`çš„æ—¶å€™ä¼šå‘ç”Ÿ
```cs
var info = new SerializationInfo(typeof(Person), new FormatterConverter());
person.GetObjectData(info, context);
```

æ„é€  SerializationInfo å¯¹è±¡æ—¶ï¼Œæ ¼å¼åŒ–å™¨è¦ä¼ é€’ä¸¤ä¸ªå‚æ•°ï¼šType å’Œ System.Runtime.Serialization.IFormatterConverter
- Typeå‚æ•°æ ‡è¯†è¦åºåˆ—åŒ–çš„å¯¹è±¡
- IFormatterConverterç±»å‹è½¬æ¢å™¨ï¼Œåœ¨è¯»å–/å†™å…¥æ•°æ®æ—¶åšç±»å‹è½¬æ¢


GetObjectData æ–¹æ³•å†³å®šéœ€è¦å“ªäº›ä¿¡æ¯æ¥åºåˆ—åŒ–å¯¹è±¡ï¼Œå¹¶å°†è¿™äº›ä¿¡æ¯æ·»åŠ åˆ° SerializationInfo å¯¹è±¡ä¸­ã€‚GetObjectData è°ƒç”¨ SerializationInfo ç±»å‹æä¾›çš„ AddValue æ–¹æ³•çš„ä¼—å¤šé‡è½½ç‰ˆæœ¬ä¹‹ä¸€æŒ‡å®šè¦åºåˆ—åŒ–çš„ä¿¡æ¯ã€‚

æ ¼å¼åŒ–å™¨è·å–å·²ç»æ·»åŠ åˆ° SerializationInfo å¯¹è±¡çš„æ‰€æœ‰å€¼ï¼Œå¹¶æŠŠå®ƒä»¬éƒ½åºåˆ—åŒ–åˆ°æµä¸­ã€‚

ååºåˆ—åŒ–æµç¨‹ï¼š
- æ ¼å¼åŒ–å™¨ä»æµä¸­æå–ä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œä¼šä¸ºæ–°å¯¹è±¡åˆ†é…å†…å­˜
- æ ¼å¼åŒ–å™¨æ£€æŸ¥ç±»å‹æ˜¯å¦å®ç°äº† ISerializable æ¥å£ã€‚å¦‚æœå­˜åœ¨è¿™ä¸ªæ¥å£ï¼Œæ ¼å¼åŒ–å™¨å°±å°è¯•è°ƒç”¨ä¸€ä¸ªç‰¹æ®Šæ„é€ å™¨ï¼Œå®ƒçš„å‚æ•°å’Œ GetObjectData æ–¹æ³•çš„å®Œå…¨ä¸€è‡´ï¼ˆå¦‚æœè‡ªå®šä¹‰ç±»æ˜¯å¯†å°ç±»ï¼Œå¼ºçƒˆå»ºè®®å°†è¿™ä¸ªç‰¹æ®Šæ„é€ å™¨å£°æ˜ä¸º privateã€‚è¿™æ ·å¯é˜²æ­¢ä»»ä½•ä»£ç ä¸æ…è°ƒç”¨å®ƒï¼Œä»è€Œæå‡å®‰å…¨æ€§ï¼‰
- æ„é€ å™¨è·å–ä¸€ä¸ª SerializationInfo å¯¹è±¡å¼•ç”¨ã€‚åœ¨è¿™ä¸ª SerializationInfo å¯¹è±¡ä¸­ï¼ŒåŒ…å«äº†å¯¹è±¡åºåˆ—åŒ–æ—¶æ·»åŠ çš„æ‰€æœ‰å€¼
- ç‰¹æ®Šæ„é€ å™¨å¯è°ƒç”¨ GetBooleanï¼ŒGetChar ç­‰ä»»ä½•ä¸€ä¸ªæ–¹æ³•ï¼Œå‘å®ƒä¼ é€’ä¸åºåˆ—åŒ–ä¸€ä¸ªå€¼æ‰€ç”¨çš„åç§°å¯¹åº”çš„å­—ç¬¦ä¸²
- å¦‚æœå€¼åœ¨æµä¸­çš„ç±»å‹å’Œè¯•å›¾è·å–(Get)çš„ç±»å‹ä¸ç¬¦ï¼Œæ ¼å¼åŒ–å™¨ä¼šå°è¯•ç”¨ä¸€ä¸ª IFormatterConverter å¯¹è±¡å°†æµä¸­çš„å€¼è½¬å‹æˆä½ æŒ‡å®šçš„ç±»å‹


å½“ä½ çš„ç±»å‹ç»§æ‰¿äº†ä¸€ä¸ªå®ç° ISerializable çš„åŸºç±»æ—¶ï¼Œä¸ºäº†ç¡®ä¿å®Œæ•´çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œä½ çš„ GetObjectData å’Œç‰¹æ®Šæ„é€ å™¨ä¸­å¿…é¡»è°ƒç”¨åŸºç±»å¯¹åº”æ–¹æ³•ï¼›å¦åˆ™ï¼Œå¦‚æœæ´¾ç”Ÿç±»æ²¡æœ‰æ–°å¢æ•°æ®ï¼Œå®Œå…¨å¯ä»¥ä¸ç”¨å®ç° ISerializableï¼Œæ ¼å¼åŒ–å™¨ä¼šè‡ªåŠ¨æ²¿ç»§æ‰¿é“¾æŸ¥æ‰¾åŸºç±»çš„ååºåˆ—åŒ–æ„é€ å™¨ã€‚

```cs
using System;
using System.Runtime.Serialization;

// åŸºç±»å®ç° ISerializable
[Serializable]
public class BasePerson : ISerializable
{
    public string Name;

    public BasePerson() { }

    // ååºåˆ—åŒ–æ„é€ å™¨
    protected BasePerson(SerializationInfo info, StreamingContext context)
    {
        Name = info.GetString("Name");
    }

    // åºåˆ—åŒ–æ–¹æ³•
    public virtual void GetObjectData(SerializationInfo info, StreamingContext context)
    {
        info.AddValue("Name", Name);
    }
}

// æ´¾ç”Ÿç±»ä¹Ÿå®ç° ISerializableï¼Œä¸”æœ‰æ–°å¢å­—æ®µ Age
[Serializable]
public class Person : BasePerson, ISerializable
{
    public int Age;

    public Person() { }

    // æ´¾ç”Ÿç±»çš„ååºåˆ—åŒ–æ„é€ å™¨
    protected Person(SerializationInfo info, StreamingContext context) : base(info, context)
    {
        // å…ˆè°ƒç”¨åŸºç±»æ„é€ å™¨ï¼Œå†ååºåˆ—åŒ–è‡ªå·±çš„å­—æ®µ
        Age = info.GetInt32("Age");
    }

    // æ´¾ç”Ÿç±»é‡å†™åºåˆ—åŒ–æ–¹æ³•
    public override void GetObjectData(SerializationInfo info, StreamingContext context)
    {
        // å…ˆè°ƒç”¨åŸºç±»çš„åºåˆ—åŒ–æ–¹æ³•ï¼Œåºåˆ—åŒ–åŸºç±»å­—æ®µ
        base.GetObjectData(info, context);
        // å†åºåˆ—åŒ–æ´¾ç”Ÿç±»å­—æ®µ
        info.AddValue("Age", Age);
    }
}
```

**è¦å®ç° ISerializable ä½†åŸºç±»å‹æ²¡æœ‰å®ç°æ€ä¹ˆåŠï¼Ÿ**

å½“åŸºç±»æœªå®ç° ISerializable æ—¶ï¼Œæ´¾ç”Ÿç±»å®ç°è¯¥æ¥å£å¿…é¡»è‡ªå·±æ‰‹åŠ¨åºåˆ—åŒ–å’Œååºåˆ—åŒ–åŸºç±»å­—æ®µï¼Œä¸”è¿™é€šå¸¸åªå¯¹åŸºç±»å­—æ®µä¸æ˜¯ç§æœ‰çš„æƒ…å†µä¸‹å¯è¡Œï¼Œå¦åˆ™å¾ˆéš¾ä¿è¯å®Œæ•´çš„åºåˆ—åŒ–ã€‚

```cs
using System;
using System.Runtime.Serialization;
using System.IO;
using System.Runtime.Serialization.Formatters.Binary;

// åŸºç±»æœªå®ç° ISerializable
[Serializable]
public class BasePerson
{
    public string Name;

    public BasePerson() { }

    public BasePerson(string name)
    {
        Name = name;
    }
}

// æ´¾ç”Ÿç±»å®ç° ISerializable
[Serializable]
public class Person : BasePerson, ISerializable
{
    public int Age;

    public Person() { }

    public Person(string name, int age) : base(name)
    {
        Age = age;
    }

    // ååºåˆ—åŒ–æ„é€ å™¨ï¼Œå¿…é¡»æ‰‹åŠ¨ååºåˆ—åŒ–åŸºç±»å­—æ®µ
    [SecurityPermissionAttribute(SecurityAction.Demand, SerializationFormatter = true)]
    protected Person(SerializationInfo info, StreamingContext context)
    {
        // æ‰‹åŠ¨ä» SerializationInfo è¯»å–åŸºç±»å­—æ®µ
        Name = info.GetString("Name");
        Age = info.GetInt32("Age");
    }

    // æ‰‹åŠ¨åºåˆ—åŒ–åŸºç±»å­—æ®µ
    [SecurityPermissionAttribute(SecurityAction.Demand, SerializationFormatter = true)]
    public void GetObjectData(SerializationInfo info, StreamingContext context)
    {
        // æ‰‹åŠ¨æ·»åŠ åŸºç±»å­—æ®µ
        info.AddValue("Name", Name);
        // æ·»åŠ æ´¾ç”Ÿç±»å­—æ®µ
        info.AddValue("Age", Age);
    }
}
```


### 24.6 æµä¸Šä¸‹æ–‡
ä¸€ç»„åºåˆ—åŒ–å¥½çš„å¯¹è±¡å¯ä»¥æœ‰è®¸å¤šç›®çš„åœ°ï¼šåŒä¸€ä¸ªè¿›ç¨‹ã€åŒä¸€å°æœºå™¨ä¸Šçš„ä¸åŒè¿›ç¨‹ã€ä¸åŒæœºå™¨ä¸Šçš„ä¸åŒè¿›ç¨‹ç­‰ã€‚

StreamingContext ç»“æ„ä¸­åŒ…å«ä¸¤ä¸ªæˆå‘˜ï¼š
| æˆå‘˜åç§°      | ç±»å‹                       | è¯´æ˜                                                           |
| --------- | ------------------------ | ------------------------------------------------------------ |
| `State`   | `StreamingContextStates` | ä¸€ä¸ªæšä¸¾çš„ä½æ ‡å¿—ï¼Œè¡¨ç¤ºå¯¹è±¡çš„åºåˆ—åŒ–/ååºåˆ—åŒ–ç”¨é€”æˆ–æ¥æºï¼ˆæ¯”å¦‚æ˜¯ä¸ºäº†è·¨ AppDomain ä¼ è¾“ã€ä¸ºäº†æŒä¹…åŒ–ã€ä¸ºäº†å…‹éš†ç­‰ï¼‰ |
| `Context` | `object`                 | ä»»ä½•ä½ æƒ³ä¼ é€’ç»™åºåˆ—åŒ–è¿‡ç¨‹çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚å¯ä»¥æ˜¯ `null`ï¼Œä¹Ÿå¯ä»¥æ˜¯ä½ è‡ªå®šä¹‰çš„å¯¹è±¡                    |


StreamingContextStatesåˆ›å»ºæšä¸¾ï¼š
| æšä¸¾å€¼                          | è¯´æ˜               |
| ---------------------------- | ---------------- |
| `StreamingContextStates.All` | æ‰€æœ‰å¯èƒ½çš„ä¸Šä¸‹æ–‡ï¼ˆé»˜è®¤ï¼‰     |
| `Clone`                      | å½“å‰åºåˆ—åŒ–æ˜¯ä¸ºäº†å…‹éš†å¯¹è±¡     |
| `CrossAppDomain`             | ç”¨äºè·¨ AppDomain ä¼ è¾“ |
| `CrossProcess`               | ç”¨äºè·¨è¿›ç¨‹ä¼ è¾“          |
| `CrossMachine`               | ç”¨äºç½‘ç»œä¼ è¾“           |
| `File`                       | ç”¨äºä¿å­˜åˆ°æ–‡ä»¶          |
| `Persistence`                | ç”¨äºæŒä¹…åŒ–ä¿å­˜          |
| `Remoting`                   | ç”¨äºè¿œç¨‹é€šä¿¡           |
| `Other`                      | å…¶ä»–æœªæŒ‡å®šç”¨é€”          |

stateä½¿ç”¨æ¯”å¦‚ï¼š
```cs
public void GetObjectData(SerializationInfo info, StreamingContext context)
{
    if (context.State == StreamingContextStates.Clone)
    {
        // å…‹éš†æ—¶çš„åºåˆ—åŒ–é€»è¾‘
    }
    else
    {
        // å…¶ä»–åºåˆ—åŒ–é€»è¾‘
    }
}
```
Context æ˜¯ä¸€ä¸ª object ç±»å‹,å¯ä»¥ä¼ å…¥çš„ä»»ä½•é™„åŠ æ•°æ®:
```cs
var myInfo = new MySerializationHint { SomeFlag = true };
var context = new StreamingContext(StreamingContextStates.Clone, myInfo);
formatter.Context = context;

// ç„¶ååœ¨åºåˆ—åŒ–ä»£ç é‡Œç”¨ï¼š
var hint = (MySerializationHint)context.Context;
if (hint.SomeFlag) {
    // æ ¹æ®æç¤ºåšç‰¹æ®Šå¤„ç†
}
```

### 24.7 ç±»å‹åºåˆ—åŒ–ä¸ºä¸åŒç±»å‹ä»¥åŠå¯¹è±¡ååºåˆ—åŒ–ä¸ºä¸åŒå¯¹è±¡
Microsoft å¼ºçƒˆæ¨èä½¿ç”¨æ›´å®‰å…¨ã€è·¨å¹³å°çš„åºåˆ—åŒ–å™¨ï¼Œæ¯”å¦‚ï¼š
- System.Text.Jsonï¼ˆæ¨èï¼Œé»˜è®¤ JSON åºåˆ—åŒ–å™¨ï¼‰
- Newtonsoft.Json
- XmlSerializer
- ataContractSerializer
- protobuf-net ç­‰ç¬¬ä¸‰æ–¹åº“

æœ‰ä¸€ç§åœºæ™¯ï¼šå•ä¾‹æ¨¡å¼ï¼ˆSingletonï¼‰ çš„åºåˆ—åŒ–/ååºåˆ—åŒ–ï¼Œåœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­ï¼Œå¦‚æœå·²ç»å­˜åœ¨æŸä¸ªå¯¹è±¡å®ä¾‹ï¼Œå¸Œæœ›ååºåˆ—åŒ–åè¿”å›è¿™ä¸ªå·²å­˜åœ¨çš„å®ä¾‹ï¼Œè€Œä¸æ˜¯åˆ›å»ºæ–°å¯¹è±¡ã€‚

```cs
using System;
using System.Runtime.Serialization;
using System.Security.Permissions;
using System.Runtime.Serialization.Formatters.Binary;

void Main()
{
    var original = Singleton.GetSingleton();

    using var ms = new MemoryStream();
    var formatter = new BinaryFormatter();

    formatter.Serialize(ms, original);

    ms.Position = 0;
    var deserialized = (Singleton)formatter.Deserialize(ms);

    Console.WriteLine(ReferenceEquals(original, deserialized)); // True
}

[Serializable]
public class Singleton : ISerializable
{
    // è¿™æ˜¯è¯¥ç±»å‹çš„ä¸€ä¸ªå®ä¾‹
    private static readonly Singleton s_theOneObject = new Singleton();
    
    // è¿™äº›æ˜¯å®ä¾‹å­—æ®µ
    public String Name = "cedar";
    public DateTime Date = DateTime.Now;
    
    // ç§æœ‰æ„é€ å™¨ï¼Œå…è®¸è¿™ä¸ªç±»å‹æ„é€ å•å®ä¾‹
    private Singleton(){}
    
    // è¯¥æ–¹æ³•è¿”å›å¯¹å•å®ä¾‹çš„å¼•ç”¨
    public static Singleton GetSingleton(){
        return s_theOneObject;
    }
    
    // åºåˆ—åŒ–ä¸€ä¸ªsingletonæ—¶è°ƒç”¨çš„æ–¹æ³•
    // å»ºè®®åœ¨è¿™é‡Œä½¿ç”¨ä¸€ä¸ªæ˜¾ç¤ºæ¥å£æ–¹æ³•å®ç°ï¼ˆEIMIï¼‰ISerializable.GetObjectData
    [SecurityPermissionAttribute(SecurityAction.Demand, SerializationFormatter = true)]
    void ISerializable.GetObjectData(SerializationInfo info, StreamingContext context){
        /*
        å‘Šè¯‰åºåˆ—åŒ–å™¨ï¼š
            ä¸è¦æŒ‰ç…§å½“å‰å¯¹è±¡çš„ç±»å‹ï¼ˆSingletonï¼‰å»ååºåˆ—åŒ–ï¼Œ
            è€Œæ˜¯ååºåˆ—åŒ–æˆ SingletonSerializationHelper ç±»å‹çš„å¯¹è±¡ã€‚
        */
        info.SetType(typeof(SingletonSerializationHelper));
        // ä¸éœ€è¦æ·»åŠ å…¶ä»–å€¼
    }
    
    [Serializable]
    private sealed class SingletonSerializationHelper : IObjectReference{
        // è¿™ä¸ªæ–¹æ³•åœ¨å¯¹è±¡ååºåˆ—åŒ–åè°ƒç”¨
        public Object GetRealObject(StreamingContext context){
            return Singleton.GetSingleton();
        }
    }
    // æ³¨æ„ï¼šç‰¹æ®Šæ„é€ å™¨æ˜¯ä¸å¿…è¦çš„ï¼Œå› ä¸ºå®ƒæ°¸è¿œä¸ä¼šè°ƒç”¨
    /*
    å› ä¸ºæ ¹æœ¬ä¸æ‰“ç®—ååºåˆ—åŒ– Singleton æœ¬èº«ï¼Œ
    è€Œæ˜¯é€šè¿‡ info.SetType(...) æŠŠååºåˆ—åŒ–è½¬ç»™äº† SingletonSerializationHelperï¼Œ
    æ‰€ä»¥ Singleton çš„é‚£ä¸ªâ€œååºåˆ—åŒ–æ„é€ å™¨â€æ ¹æœ¬ä¸ä¼šç”¨åˆ°
    */
}
```

### 24.8 åºåˆ—åŒ–ä»£ç†
æœ‰ä¸€äº›æƒ…å†µæ¯”å¦‚ï¼š
- ç±»å‹æœªæ ‡è®°ä¸ºå¯åºåˆ—åŒ–
- ç±»å‹ä¸­åŒ…å«æ— æ³•åºåˆ—åŒ–çš„æˆå‘˜
- ç±»å‹è®¾è®¡ä¸Šä¸æ”¯æŒåºåˆ—åŒ–
- ç‰ˆæœ¬ä¸å…¼å®¹

ç­‰åœºæ™¯å¯¼è‡´æ ¼å¼åŒ–å™¨ï¼ˆæ¯”å¦‚ .NET ä¸­çš„ BinaryFormatterã€SoapFormatter æˆ– JSON åºåˆ—åŒ–å™¨ï¼‰ä¸ä¼šæˆ–ä¸èƒ½æ­£ç¡®åºåˆ—åŒ–/ååºåˆ—åŒ–æŸä¸ªç±»å‹ã€‚

è¿™æ—¶éœ€è¦ç”¨åˆ°åºåˆ—åŒ–ä»£ç†ï¼Œå¯ä»¥ç†è§£â€œä»£ç†â€å°±åƒæ˜¯ä¸€ä¸ªæ›¿èº«æˆ–â€œç¿»è¯‘å®˜â€ï¼Œå¸®æ ¼å¼åŒ–å™¨å¤„ç†é‚£äº›å®ƒæœ¬èº«â€œä¸ä¼šâ€æˆ–è€…â€œä¸èƒ½â€æ­£ç¡®åºåˆ—åŒ–/ååºåˆ—åŒ–çš„ç±»å‹ã€‚

åºåˆ—åŒ–ä»£ç†çš„æ ¸å¿ƒæ€æƒ³ï¼šä¸ç›´æ¥åºåˆ—åŒ–åŸå§‹å¯¹è±¡æœ¬èº«ï¼Œè€Œæ˜¯åºåˆ—åŒ–ä¸€ä¸ªâ€œä»£ç†å¯¹è±¡â€ï¼ˆä»£ç†ç±»å‹ï¼‰ï¼Œåœ¨ååºåˆ—åŒ–æ—¶ï¼Œé€šè¿‡ä»£ç†å¯¹è±¡è¿”å›çœŸæ­£çš„ç›®æ ‡å¯¹è±¡ã€‚

åºåˆ—åŒ–ä»£ç†ç±»å‹å¿…é¡»å®ç° System.Runtime.Serialization.ISerializationSurrogate æ¥å£ï¼Œå®ƒåœ¨ FCL ä¸­åƒä¸‹é¢è¿™æ ·å®šä¹‰ï¼š
```cs
public interface ISerializationSurrogate {
    void GetObjectData(Object obj, SerializationInfo info, StreamingContext context);

    Object SetObjectData(Object obj, SerializationInfo info, StreamingContext context,
        ISurrogateSelector selector);
}
```

ä¾‹å­ï¼š
```cs
void Main()
{
    var person = new Person { Name = "Alice", Age = 30 };
     
    var formatter = new BinaryFormatter();
     // åˆ›å»ºä»£ç†é€‰æ‹©å™¨
    var surrogateSelector = new SurrogateSelector();
     // å‘Šè¯‰ä»£ç†é€‰æ‹©å™¨ä¸ºPersonå¯¹è±¡ä½¿ç”¨æˆ‘ä»¬çš„ä»£ç†
    surrogateSelector.AddSurrogate( // AddSurrogateå¯å¤šæ¬¡è°ƒç”¨ç™»è®°å¤šä¸ªä»£ç†
            typeof(Person),                         // ä»£ç†é’ˆå¯¹çš„ç±»å‹
            formatter.Context,
            new PersonSerializationSurrogate());  // ä»£ç†ç±»
    // å‘Šè¯‰æ ¼å¼åŒ–å™¨ä½¿ç”¨ä»£ç†é€‰æ‹©å™¨
    formatter.SurrogateSelector = surrogateSelector;
     
    // åºåˆ—åŒ–
    using (var ms = new MemoryStream())
    {
        formatter.Serialize(ms, person);
        ms.Position = 0;

        // ååºåˆ—åŒ–
        var deserializedPerson = (Person)formatter.Deserialize(ms);

        Console.WriteLine($"Name: {deserializedPerson.Name}, Age: {deserializedPerson.Age}");
    }

}

// è¿™æ˜¯ä¸€ä¸ªæ²¡æœ‰æ ‡è®° [Serializable] çš„ç±»
public class Person
{
    public string Name;
    public int Age;
}

// åºåˆ—åŒ–ä»£ç†ï¼Œå®ç° ISerializationSurrogate
public class PersonSerializationSurrogate : ISerializationSurrogate
{
    // åºåˆ—åŒ–æ—¶è°ƒç”¨
    public void GetObjectData(object obj, SerializationInfo info, StreamingContext context)
    {
        Person p = (Person)obj;
        info.AddValue("Name", p.Name);
        info.AddValue("Age", p.Age);
    }

    // ååºåˆ—åŒ–æ—¶è°ƒç”¨ï¼Œé‡å»ºå¯¹è±¡
    public object SetObjectData(object obj, SerializationInfo info, StreamingContext context, ISurrogateSelector selector)
    {
        Person p = (Person)obj;
        p.Name = info.GetString("Name");
        p.Age = info.GetInt32("Age");
        return p;
    }
}
```

**ä»£ç†é€‰æ‹©å™¨é“¾**
â€œä»£ç†é€‰æ‹©å™¨é“¾â€ï¼ˆSurrogate Selector Chainï¼‰æ˜¯ .NET ä¸­çš„ä¸€ç§æœºåˆ¶ï¼Œå…è®¸å°†å¤šä¸ªåºåˆ—åŒ–ä»£ç†é€‰æ‹©å™¨ï¼ˆISurrogateSelectorï¼‰é“¾æ¥èµ·æ¥ï¼Œé€çº§æŸ¥æ‰¾åˆé€‚çš„åºåˆ—åŒ–ä»£ç†ã€‚

å°±æ˜¯ç»Ÿä¸€å…¥å£ï¼Œç„¶åè®©ç¨‹åºè‡ªå·±æ‰¾åˆ°å¯¹åº”çš„ä»£ç†ã€‚

```cs
void Main()
{
    var formatter = new BinaryFormatter();

    var selector1 = new SurrogateSelector();
    var selector2 = new SurrogateSelector();

    // selector2 æ³¨å†Œ Person ç±»å‹çš„ä»£ç†
    selector2.AddSurrogate(
        typeof(Person),
        new StreamingContext(StreamingContextStates.All),
        new PersonSerializationSurrogate());

    // å°† selector2 æ·»åŠ åˆ° selector1 çš„é“¾ä¸Š
    selector1.ChainSelector(selector2);

    // è®¾ç½®ç»™ formatter
    formatter.SurrogateSelector = selector1;

    // æµ‹è¯•å¯¹è±¡
    var person = new Person { Name = "Bob", Age = 40 };

    using var ms = new MemoryStream();
    formatter.Serialize(ms, person);
    ms.Position = 0;

    var result = (Person)formatter.Deserialize(ms);
    Console.WriteLine($"{result.Name}, {result.Age}");

}

// æ²¡æœ‰æ ‡è®° [Serializable]
public class Person
{
    public string Name;
    public int Age;
}

public class PersonSerializationSurrogate : ISerializationSurrogate
{
    public void GetObjectData(object obj, SerializationInfo info, StreamingContext context)
    {
        var p = (Person)obj;
        info.AddValue("Name", p.Name);
        info.AddValue("Age", p.Age);
    }

    public object SetObjectData(object obj, SerializationInfo info, StreamingContext context, ISurrogateSelector selector)
    {
        var p = (Person)obj;
        p.Name = info.GetString("Name");
        p.Age = info.GetInt32("Age");
        return p;
    }
}
```

formatter --> selector1 --> selector2 --> selector3 ... etc.

ä¸Šé¢çš„ä¾‹å­selector1ä¸åŒ¹é…ï¼Œæ‰€ä»¥ä¼ é€’ç»™selector2ã€‚

### 24.9 ååºåˆ—åŒ–å¯¹è±¡æ—¶é‡å†™ç¨‹åºé›†å’Œ/æˆ–ç±»å‹
åºåˆ—åŒ–å¯¹è±¡æ—¶ï¼Œæ ¼å¼åŒ–å™¨è¾“å‡ºç±»å‹åŠå…¶å®šä¹‰ç¨‹åºé›†çš„å…¨åã€‚ååºåˆ—åŒ–å¯¹è±¡æ—¶ï¼Œæ ¼å¼åŒ–å™¨æ ¹æ®è¿™ä¸ªä¿¡æ¯ç¡®å®šè¦ä¸ºå¯¹è±¡æ„é€ å¹¶åˆå§‹åŒ–ä»€ä¹ˆç±»å‹ã€‚

æœ‰äº›åœºæ™¯æœ‰å¿…è¦å°†å¯¹è±¡ååºåˆ—åŒ–æˆå’Œåºåˆ—åŒ–æ—¶ä¸åŒçš„ç±»å‹ï¼š
- å¼€å‘äººå‘˜å¯èƒ½æƒ³æŠŠä¸€ä¸ªç±»å‹çš„å®ç°ä»ä¸€ä¸ªç¨‹åºé›†ç§»åŠ¨åˆ°å¦ä¸€ä¸ªç¨‹åºé›†
- å¼€å‘äººå‘˜åˆ›å»ºäº†ç±»å‹çš„æ–°ç‰ˆæœ¬ï¼Œæƒ³æŠŠå·²åºåˆ—åŒ–çš„å¯¹è±¡ååºåˆ—åŒ–æˆç±»å‹çš„æ–°ç‰ˆæœ¬

åˆ©ç”¨ System.Runtime.Serialization.SerializationBinder ç±»ï¼Œå‡è®¾ç‰ˆæœ¬ 1.0.0.0 çš„ç¨‹åºé›†å®šä¹‰äº†åä¸º Ver1 çš„ç±»ï¼Œå¹¶å‡å®šç¨‹åºé›†çš„æ–°ç‰ˆæœ¬å®šä¹‰äº† Ver1ToVer2SerializationBinder ç±»ï¼Œè¿˜å®šä¹‰äº†åä¸º Ver2 çš„ç±»ï¼š
```cs
void Main(){
    var formatter = new BinaryFormatter();
    formatter.Binder = new Ver1ToVer2SerializationBinder();

    var obj = formatter.Deserialize(stream);  // Ver1 å¯¹è±¡å°†å˜æˆ Ver2 å®ä¾‹
}
internal sealed class Ver1ToVer2SerializationBinder : SerializationBinder {
    // åºåˆ—åŒ–å™¨åœ¨ååºåˆ—åŒ–æ—¶ä¼šè°ƒç”¨BindToType
    public override Type BindToType(String assemblyName, String typeName) {
        // assemblyNameï¼šåºåˆ—åŒ–æ•°æ®ä¸­è®°å½•çš„å®šä¹‰è¯¥ç±»å‹çš„ç¨‹åºé›†çš„åç§°ï¼ˆå¸¦ç‰ˆæœ¬å·ç­‰ä¿¡æ¯ï¼‰
        // å°†ä»»ä½• Ver1 å¯¹è±¡ä»ç‰ˆæœ¬ 1.0.0.0 ååºåˆ—åŒ–æˆä¸€ä¸ª Ver2 å¯¹è±¡

        // è®¡ç®—å®šä¹‰ Ver1 ç±»å‹çš„ç¨‹åºé›†åç§°
        // è·å–å½“å‰æ­£åœ¨æ‰§è¡Œçš„ç¨‹åºé›†çš„åç§°ï¼Œå¹¶æ‰‹åŠ¨å°†ç‰ˆæœ¬å·è®¾ä¸º 1.0.0.0
        AssemblyName assemVer1 = Assembly.GetExecutingAssembly().GetName();
        assemVer1.Version = new Version(1, 0, 0, 0);

        // å¦‚æœååºåˆ—åŒ–æµä¸­è®°å½•çš„æ˜¯æ¥è‡ª "1.0.0.0" ç‰ˆæœ¬çš„ Ver1 ç±»å‹ï¼Œå¼ºåˆ¶è¿”å›å½“å‰ç¨‹åºé›†ä¸­çš„ Ver2 ç±»å‹æ¥ä»£æ›¿ Ver1
        if (assemblyName == assemVer1.ToString() && typeName == "Ver1")
            return typeof(Ver2);

        // å¦åˆ™ï¼Œå°±åªè¿”å›è¯·æ±‚çš„åŒä¸€ä¸ªç±»å‹
        return Type.GetType(String.Format("{0}, {1}", typeName, assemblyName));
    }
}
```

