# 0-asp.net core-中间件基础
## 1、request到response的历程
![2024-10-17-13-20-39.png](./images/2024-10-17-13-20-39.png)

EndPoint（终结点）中间件一般为相应的应用类型，比如MVC。

![2024-10-17-13-57-55.png](./images/2024-10-17-13-57-55.png)

中间件是ASP.NET CORE提供的功能，而Filter是ASP.NET CORE MVC提供的功能。

中间件是一种装配到应用管道以处理请求和响应的软件。 每个组件：
- 选择是否将请求传递到管道中的下一个组件
- 可在管道中的下一个组件前后执行工作

## 2、中间件管道
### 2.1 Run
该方法为HTTP请求管道添加一个中间件，并标识该中间件为管道终点，称为终端中间件。也就是说，该中间件就是管道的末尾，在该中间件之后注册的中间件将永远都不会被执行。这是单个请求委托。

将这个方法放在第一个注册的位置，然后执行项目，可以看到出现的不是swagger页面而是hello world。
```cs
app.Run(async context =>
{
    Console.WriteLine("hello world");
    await context.Response.WriteAsync("Hello world!");
});
```
![2024-10-18-09-44-14.png](./images/2024-10-18-09-44-14.png)


### 2.2 Use
需要多个委托执行中间件执行前后的逻辑的话，就使用Use。可以按过滤器的逻辑理解。

![2024-10-18-09-55-13.png](./images/2024-10-18-09-55-13.png)

next 参数表示管道中的下一个委托。 可通过不调用 next 参数使管道短路。 通常可在 next 委托前后执行操作。

```cs
app.Use(async (context, next) =>
{
    Console.WriteLine("hello world1");
    await next.Invoke();
    Console.WriteLine("Hello world2!");
});
```

- 如果要将请求发送到管道中的下一个中间件，一定要记得调用next.Invoke / next()
- 如果已经开始给客户端发送Response，请千万不要调用next.Invoke / next()，也不要对Response进行任何更改，否则，将抛出异常
- 可以通过context.Response.HasStarted来判断响应是否已开始

```cs
app.Use(async (context, next) =>
{
    Console.WriteLine("hello world1");
    await context.Response.WriteAsync("Hello world!");
    await next.Invoke();
    Console.WriteLine("Hello world2!");
});
```
上面这样写是错误的，会报错。

![2024-10-18-09-57-41.png](./images/2024-10-18-09-57-41.png)

### 2.3 UseWhen
针对不同的逻辑条件创建管道分支。需要注意的是:
- 进入了管道分支后，如果管道分支不存在管道短路或终端中间件，则会再次返回到主管道
- 